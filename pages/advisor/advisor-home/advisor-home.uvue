<template>
	<view class="advisor-home-page">
		<view class="advisor-header">
			<view class="advisor-info">
				<image class="advisor-avatar" :src="advisorInfo.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
				<view class="advisor-detail">
					<text class="advisor-name">{{ advisorInfo.realName }}</text>
					<text class="advisor-title">{{ advisorInfo.title }}</text>
				</view>
			</view>
			<view class="advisor-actions">
				<view class="advisor-action" @click="goToNotification">
					<text class="advisor-action-icon">ğŸ””</text>
					<view v-if="unreadCount > 0" class="advisor-badge">
						<text class="advisor-badge-text">{{ unreadCount }}</text>
					</view>
				</view>
			</view>
		</view>
		
		<view class="advisor-stats">
			<view class="advisor-stat">
				<text class="advisor-stat-value">{{ stats.clientCount }}</text>
				<text class="advisor-stat-label">ç®¡ç†å®¢æˆ·</text>
			</view>
			<view class="advisor-stat">
				<text class="advisor-stat-value">{{ formatMoney(stats.totalAssets) }}</text>
				<text class="advisor-stat-label">ç®¡ç†èµ„äº§(ä¸?</text>
			</view>
			<view class="advisor-stat">
				<text class="advisor-stat-value">{{ stats.monthOrders }}</text>
				<text class="advisor-stat-label">æœ¬æœˆæˆäº¤</text>
			</view>
		</view>
		
		<view class="advisor-quick">
			<view class="advisor-quick-item" @click="goToClients">
				<view class="advisor-quick-icon">
					<text class="advisor-quick-icon-text">ğŸ‘¥</text>
				</view>
				<text class="advisor-quick-text">å®¢æˆ·ç®¡ç†</text>
			</view>
			<view class="advisor-quick-item" @click="goToAlerts">
				<view class="advisor-quick-icon">
					<text class="advisor-quick-icon-text">âš ï¸</text>
				</view>
				<text class="advisor-quick-text">é£é™©é¢„è­¦</text>
				<view v-if="alertCount > 0" class="advisor-quick-badge">{{ alertCount }}</view>
			</view>
			<view class="advisor-quick-item" @click="goToPlans">
				<view class="advisor-quick-icon">
					<text class="advisor-quick-icon-text">ğŸ“‹</text>
				</view>
				<text class="advisor-quick-text">ç†è´¢æ–¹æ¡ˆ</text>
			</view>
			<view class="advisor-quick-item" @click="goToPerformance">
				<view class="advisor-quick-icon">
					<text class="advisor-quick-icon-text">ğŸ“Š</text>
				</view>
				<text class="advisor-quick-text">ä¸šç»©ç»Ÿè®¡</text>
			</view>
		</view>
		
		<view class="advisor-section">
			<view class="advisor-section-header">
				<text class="advisor-section-title">å¾…å¤„ç†äº‹é¡?/text>
				<text class="advisor-section-more" @click="goToTasks">æŸ¥çœ‹å…¨éƒ¨ â€?/text>
			</view>
			<view class="advisor-tasks">
				<view 
					v-for="(task, index) in pendingTasks" 
					:key="index"
					class="advisor-task"
					@click="handleTask(task)"
				>
					<view class="advisor-task-icon" :class="getTaskClass(task.type)">
						<text class="advisor-task-icon-text">{{ getTaskIcon(task.type) }}</text>
					</view>
					<view class="advisor-task-info">
						<text class="advisor-task-title">{{ task.title }}</text>
						<text class="advisor-task-desc">{{ task.description }}</text>
					</view>
					<text class="advisor-task-time">{{ task.time }}</text>
				</view>
				<sg-empty v-if="pendingTasks.length === 0" text="æš‚æ— å¾…å¤„ç†äº‹é¡? />
			</view>
		</view>
		
		<view class="advisor-section">
			<view class="advisor-section-header">
				<text class="advisor-section-title">é‡ç‚¹å…³æ³¨å®¢æˆ·</text>
				<text class="advisor-section-more" @click="goToClients">æŸ¥çœ‹å…¨éƒ¨ â€?/text>
			</view>
			<view class="advisor-focus-clients">
				<view 
					v-for="(client, index) in focusClients" 
					:key="index"
					class="advisor-client"
					@click="goToClientDetail(client.userId)"
				>
					<image class="advisor-client-avatar" :src="client.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
					<view class="advisor-client-info">
						<text class="advisor-client-name">{{ client.realName }}</text>
						<text class="advisor-client-assets">èµ„äº§ Â¥{{ formatAssets(client.totalAssets) }}</text>
					</view>
					<view class="advisor-client-tag" :class="getClientTagClass(client.riskLevel)">
						<text class="advisor-client-tag-text">{{ getRiskText(client.riskLevel) }}</text>
					</view>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getStorage } from '@/utils/storage.uts'
	import { RISK_LEVEL_MAP, USER_INFO_KEY } from '@/config/index.uts'
	
	interface AdvisorInfo {
		advisorId: number
		realName: string
		avatar: string
		title: string
	}
	
	interface Stats {
		clientCount: number
		totalAssets: number
		monthOrders: number
	}
	
	interface Task {
		id: number
		type: string
		title: string
		description: string
		time: string
	}
	
	interface Client {
		userId: number
		realName: string
		avatar: string
		totalAssets: number
		riskLevel: number
	}
	
	export default {
		data() {
			return {
				advisorInfo: {} as AdvisorInfo,
				stats: {
					clientCount: 128,
					totalAssets: 5680,
					monthOrders: 36
				} as Stats,
				unreadCount: 5,
				alertCount: 3,
				pendingTasks: [] as Task[],
				focusClients: [] as Client[]
			}
		},
		onLoad() {
			this.loadAdvisorInfo()
			this.loadPendingTasks()
			this.loadFocusClients()
		},
		methods: {
			loadAdvisorInfo() {
				const userInfo = getStorage<any>(USER_INFO_KEY)
				if (userInfo) {
					this.advisorInfo = {
						advisorId: userInfo.userId,
						realName: userInfo.realName || 'é¡¾é—®',
						avatar: userInfo.avatar,
						title: 'é«˜çº§ç†è´¢é¡¾é—®'
					}
				}
			},
			
			loadPendingTasks() {
				this.pendingTasks = [
					{ id: 1, type: 'rebalance', title: 'èµ„äº§å†å¹³è¡¡æé†?, description: 'å®¢æˆ·å¼ ä¸‰çš„èµ„äº§é…ç½®åç¦»ç›®æ ?, time: '10åˆ†é’Ÿå‰? },
					{ id: 2, type: 'expiring', title: 'äº§å“åˆ°æœŸæé†’', description: '3ä½å®¢æˆ·çš„ç†è´¢äº§å“å°†äºæœ¬å‘¨åˆ°æœŸ', time: '30åˆ†é’Ÿå‰? },
					{ id: 3, type: 'consult', title: 'å’¨è¯¢é¢„çº¦', description: 'æå››é¢„çº¦äº†ä¸‹å?ç‚¹çš„è§†é¢‘å’¨è¯¢', time: '1å°æ—¶å‰? }
				]
			},
			
			loadFocusClients() {
				this.focusClients = [
					{ userId: 1, realName: 'å¼ ä¸‰', avatar: '', totalAssets: 1500000, riskLevel: 3 },
					{ userId: 2, realName: 'æå››', avatar: '', totalAssets: 800000, riskLevel: 2 },
					{ userId: 3, realName: 'ç‹äº”', avatar: '', totalAssets: 2300000, riskLevel: 4 }
				]
			},
			
			formatMoney(num: number): string {
				return (num / 10000).toFixed(0)
			},
			
			formatAssets(num: number): string {
				if (num >= 10000) {
					return (num / 10000).toFixed(1) + 'ä¸?
				}
				return num.toString()
			},
			
			getRiskText(level: number): string {
				return RISK_LEVEL_MAP[level] || 'æœªçŸ¥'
			},
			
			getTaskIcon(type: string): string {
				const iconMap: Record<string, string> = {
					'rebalance': 'âš–ï¸',
					'expiring': 'â?,
					'consult': 'ğŸ“',
					'alert': 'âš ï¸'
				}
				return iconMap[type] || 'ğŸ“‹'
			},
			
			getTaskClass(type: string): string {
				return `advisor-task-icon--${type}`
			},
			
			getClientTagClass(level: number): string {
				const classMap: Record<number, string> = {
					1: 'advisor-client-tag--low',
					2: 'advisor-client-tag--low',
					3: 'advisor-client-tag--mid',
					4: 'advisor-client-tag--high',
					5: 'advisor-client-tag--high'
				}
				return classMap[level] || ''
			},
			
			handleTask(task: Task) {
				uni.showToast({ title: 'ä»»åŠ¡å¤„ç†åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
			},
			
			goToNotification() {
				uni.navigateTo({ url: '/pages/advisor/advisor-notification/advisor-notification' })
			},
			
			goToClients() {
				uni.navigateTo({ url: '/pages/advisor/advisor-clients/advisor-clients' })
			},
			
			goToAlerts() {
				uni.navigateTo({ url: '/pages/advisor/advisor-alerts/advisor-alerts' })
			},
			
			goToPlans() {
				uni.navigateTo({ url: '/pages/advisor/advisor-plans/advisor-plans' })
			},
			
			goToPerformance() {
				uni.navigateTo({ url: '/pages/advisor/advisor-performance/advisor-performance' })
			},
			
			goToTasks() {
				uni.navigateTo({ url: '/pages/advisor/advisor-tasks/advisor-tasks' })
			},
			
			goToClientDetail(userId: number) {
				uni.navigateTo({ url: `/pages/advisor/client-detail/client-detail?id=${userId}` })
			}
		}
	}
</script>

<style lang="scss">
	@import './advisor-home.scss';
</style>
