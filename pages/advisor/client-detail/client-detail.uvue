<template>
	<view class="client-detail-page">
		<sg-navbar title="å®¢æˆ·è¯¦æƒ…" />
		
		<view class="client-header">
			<image class="client-avatar" :src="client.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
			<view class="client-info">
				<text class="client-name">{{ client.realName }}</text>
				<view class="client-tags">
					<view class="client-tag" :class="getRiskClass(client.riskLevel)">
						<text class="client-tag-text">{{ getRiskText(client.riskLevel) }}</text>
					</view>
					<view v-if="client.isVip" class="client-tag client-tag--vip">
						<text class="client-tag-text">VIP</text>
					</view>
				</view>
			</view>
			<view class="client-actions">
				<view class="client-action" @click="makeCall">
					<text class="client-action-icon">ğŸ“</text>
				</view>
				<view class="client-action" @click="sendMessage">
					<text class="client-action-icon">ğŸ’¬</text>
				</view>
			</view>
		</view>
		
		<view class="client-assets">
			<view class="client-asset-item">
				<text class="client-asset-value">Â¥{{ formatMoney(client.totalAssets) }}</text>
				<text class="client-asset-label">æ€»èµ„äº§</text>
			</view>
			<view class="client-asset-item">
				<text class="client-asset-value" :class="client.totalReturn >= 0 ? 'text-rise' : 'text-fall'">
					{{ client.totalReturn >= 0 ? '+' : '' }}Â¥{{ formatMoney(Math.abs(client.totalReturn)) }}
				</text>
				<text class="client-asset-label">ç´¯è®¡æ”¶ç›Š</text>
			</view>
			<view class="client-asset-item">
				<text class="client-asset-value" :class="client.returnRate >= 0 ? 'text-rise' : 'text-fall'">
					{{ client.returnRate >= 0 ? '+' : '' }}{{ (client.returnRate * 100).toFixed(2) }}%
				</text>
				<text class="client-asset-label">æ”¶ç›Šç‡</text>
			</view>
		</view>
		
		<view class="client-section">
			<text class="client-section-title">åŸºæœ¬ä¿¡æ¯</text>
			<view class="client-info-list">
				<view class="client-info-item">
					<text class="client-info-label">æ‰‹æœºå·</text>
					<text class="client-info-value">{{ formatPhone(client.phone) }}</text>
				</view>
				<view class="client-info-item">
					<text class="client-info-label">é‚®ç®±</text>
					<text class="client-info-value">{{ client.email || 'æœªç»‘å®š' }}</text>
				</view>
				<view class="client-info-item">
					<text class="client-info-label">é£é™©ç­‰çº§</text>
					<text class="client-info-value">{{ getRiskText(client.riskLevel) }}</text>
				</view>
				<view class="client-info-item">
					<text class="client-info-label">åˆ†é…æ—¶é—´</text>
					<text class="client-info-value">{{ client.assignedAt }}</text>
				</view>
			</view>
		</view>
		
		<view class="client-section">
			<text class="client-section-title">èµ„äº§é…ç½®</text>
			<view class="client-portfolio">
				<view 
					v-for="(item, index) in portfolio" 
					:key="index"
					class="portfolio-item"
				>
					<view class="portfolio-bar" :style="{ width: item.percentage + '%', backgroundColor: getColor(index) }"></view>
					<text class="portfolio-name">{{ item.name }}</text>
					<text class="portfolio-amount">Â¥{{ formatMoney(item.amount) }}</text>
					<text class="portfolio-percent">{{ item.percentage }}%</text>
				</view>
			</view>
		</view>
		
		<view class="client-section">
			<view class="client-section-header">
				<text class="client-section-title">æŒä»“è®°å½•</text>
				<text class="client-section-more" @click="goToHoldings">æŸ¥çœ‹å…¨éƒ¨ â€º</text>
			</view>
			<view class="client-holdings">
				<view 
					v-for="(holding, index) in holdings" 
					:key="index"
					class="holding-item"
				>
					<text class="holding-name">{{ holding.productName }}</text>
					<view class="holding-info">
						<text class="holding-amount">Â¥{{ formatMoney(holding.amount) }}</text>
						<text class="holding-return" :class="holding.returnRate >= 0 ? 'text-rise' : 'text-fall'">
							{{ holding.returnRate >= 0 ? '+' : '' }}{{ (holding.returnRate * 100).toFixed(2) }}%
						</text>
					</view>
				</view>
			</view>
		</view>
		
		<view class="client-footer">
			<view class="client-footer-btn client-footer-btn--plan" @click="createPlan">
				<text class="client-footer-btn-text">åˆ¶å®šæ–¹æ¡ˆ</text>
			</view>
			<view class="client-footer-btn client-footer-btn--consult" @click="bookConsult">
				<text class="client-footer-btn-text">é¢„çº¦å’¨è¯¢</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { RISK_LEVEL_MAP } from '@/config/index.uts'
	import { formatPhone } from '@/utils/format.uts'
	
	interface Client {
		userId: number
		realName: string
		avatar: string
		phone: string
		email: string
		riskLevel: number
		isVip: boolean
		totalAssets: number
		totalReturn: number
		returnRate: number
		assignedAt: string
	}
	
	interface PortfolioItem {
		name: string
		amount: number
		percentage: number
	}
	
	interface Holding {
		productId: number
		productName: string
		amount: number
		returnRate: number
	}
	
	const COLORS = ['#1890FF', '#52C41A', '#FAAD14', '#F5222D', '#722ED1']
	
	export default {
		data() {
			return {
				userId: 0,
				client: {} as Client,
				portfolio: [] as PortfolioItem[],
				holdings: [] as Holding[]
			}
		},
		onLoad(options: any) {
			if (options.id) {
				this.userId = Number(options.id)
				this.loadClientDetail()
			}
		},
		methods: {
			loadClientDetail() {
				// æ¨¡æ‹Ÿæ•°æ®
				this.client = {
					userId: this.userId,
					realName: 'å¼ ä¸‰',
					avatar: '',
					phone: '13800138001',
					email: 'zhangsan@example.com',
					riskLevel: 3,
					isVip: true,
					totalAssets: 1500000,
					totalReturn: 125000,
					returnRate: 0.086,
					assignedAt: '2024-01-15'
				}
				
				this.portfolio = [
					{ name: 'è´§å¸åŸºé‡‘', percentage: 20, amount: 300000 },
					{ name: 'å€ºåˆ¸åŸºé‡‘', percentage: 35, amount: 525000 },
					{ name: 'æ··åˆåŸºé‡‘', percentage: 30, amount: 450000 },
					{ name: 'è‚¡ç¥¨åŸºé‡‘', percentage: 15, amount: 225000 }
				]
				
				this.holdings = [
					{ productId: 1, productName: 'ç¨³å¥å¢å€¼ç†è´¢A', amount: 500000, returnRate: 0.065 },
					{ productId: 2, productName: 'çµæ´»é…ç½®æ··åˆB', amount: 450000, returnRate: 0.125 },
					{ productId: 3, productName: 'è´§å¸å¢å¼ºC', amount: 300000, returnRate: 0.032 }
				]
			},
			
			formatMoney(num: number): string {
				if (num >= 10000) {
					return (num / 10000).toFixed(2) + 'ä¸‡'
				}
				return num.toFixed(2)
			},
			
			formatPhone(phone: string): string {
				return formatPhone(phone)
			},
			
			getRiskText(level: number): string {
				return RISK_LEVEL_MAP[level] || 'æœªçŸ¥'
			},
			
			getRiskClass(level: number): string {
				if (level <= 2) return 'client-tag--low'
				if (level <= 3) return 'client-tag--mid'
				return 'client-tag--high'
			},
			
			getColor(index: number): string {
				return COLORS[index % COLORS.length]
			},
			
			makeCall() {
				uni.makePhoneCall({ phoneNumber: this.client.phone })
			},
			
			sendMessage() {
				uni.showToast({ title: 'æ¶ˆæ¯åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
			},
			
			goToHoldings() {
				uni.showToast({ title: 'æŒä»“è¯¦æƒ…å¼€å‘ä¸­', icon: 'none' })
			},
			
			createPlan() {
				uni.navigateTo({ url: `/pages/advisor/create-plan/create-plan?userId=${this.userId}` })
			},
			
			bookConsult() {
				uni.showToast({ title: 'é¢„çº¦å’¨è¯¢å¼€å‘ä¸­', icon: 'none' })
			}
		}
	}
</script>
