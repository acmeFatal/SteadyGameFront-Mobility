<template>
	<view class="ai-page">
		<view class="ai-header">
			<text class="ai-title">AIæ™ºèƒ½åŠ©æ‰‹</text>
			<text class="ai-subtitle">ä¸ºæ‚¨æä¾›ä¸“ä¸šçš„ç†è´¢å»ºè®®</text>
		</view>
		
		<view class="ai-features">
			<view class="ai-feature" @click="goToChat">
				<view class="ai-feature-icon-wrap">
					<text class="ai-feature-icon">ğŸ’¬</text>
				</view>
				<view class="ai-feature-info">
					<text class="ai-feature-title">æ™ºèƒ½é—®ç­”</text>
					<text class="ai-feature-desc">æœ‰é—®å¿…ç­”ï¼Œç†è´¢çŸ¥è¯†éšæ—¶é—®</text>
				</view>
				<text class="ai-feature-arrow">â€º</text>
			</view>
			
			<view class="ai-feature" @click="goToPlan">
				<view class="ai-feature-icon-wrap">
					<text class="ai-feature-icon">ğŸ“‹</text>
				</view>
				<view class="ai-feature-info">
					<text class="ai-feature-title">ç†è´¢è§„åˆ’</text>
					<text class="ai-feature-desc">æ ¹æ®æ‚¨çš„ç›®æ ‡ç”Ÿæˆä¸“å±æ–¹æ¡ˆ</text>
				</view>
				<text class="ai-feature-arrow">â€º</text>
			</view>
			
			<view class="ai-feature" @click="goToRecommend">
				<view class="ai-feature-icon-wrap">
					<text class="ai-feature-icon">â­</text>
				</view>
				<view class="ai-feature-info">
					<text class="ai-feature-title">æ™ºèƒ½æ¨è</text>
					<text class="ai-feature-desc">ä¸ªæ€§åŒ–äº§å“åŒ¹é…æ¨è</text>
				</view>
				<text class="ai-feature-arrow">â€º</text>
			</view>
			
			<view class="ai-feature" @click="goToRiskAssess">
				<view class="ai-feature-icon-wrap">
					<text class="ai-feature-icon">ğŸ“Š</text>
				</view>
				<view class="ai-feature-info">
					<text class="ai-feature-title">é£é™©è¯„ä¼°</text>
					<text class="ai-feature-desc">æµ‹è¯„æ‚¨çš„é£é™©æ‰¿å—èƒ½åŠ›</text>
				</view>
				<text class="ai-feature-arrow">â€º</text>
			</view>
		</view>
		
		<sg-card title="æœ€è¿‘å¯¹è¯" extra="å…¨éƒ¨" @extraClick="goToChatHistory">
			<view class="ai-history">
				<view 
					v-for="(item, index) in chatSessions" 
					:key="index"
					class="ai-history-item"
					@click="goToChatDetail(item.sessionId)"
				>
					<text class="ai-history-title">{{ item.title || 'æ–°å¯¹è¯' }}</text>
					<text class="ai-history-time">{{ formatTime(item.updatedAt) }}</text>
				</view>
				<sg-empty v-if="chatSessions.length === 0" text="æš‚æ— å¯¹è¯è®°å½•" />
			</view>
		</sg-card>
		
		<view class="ai-quick-ask">
			<text class="ai-quick-title">å¿«æ·æé—®</text>
			<view class="ai-quick-tags">
				<view 
					v-for="(item, index) in quickQuestions" 
					:key="index"
					class="ai-quick-tag"
					@click="askQuestion(item)"
				>
					<text class="ai-quick-tag-text">{{ item }}</text>
				</view>
			</view>
		</view>
		
		<view class="ai-input-bar">
			<input 
				class="ai-input"
				v-model="inputText"
				placeholder="è¾“å…¥æ‚¨æƒ³é—®çš„é—®é¢˜..."
				@confirm="startChat"
			/>
			<view class="ai-voice-btn" @click="startVoiceInput">
				<text class="ai-voice-icon">ğŸ¤</text>
			</view>
			<view class="ai-send-btn" @click="startChat">
				<text class="ai-send-icon">â¤</text>
			</view>
		</view>
		
		<sg-tabbar :current="2" :list="tabList" />
	</view>
</template>

<script lang="uts">
	import { getChatSessions } from '@/api/ai.uts'
	import { getRelativeTime } from '@/utils/date.uts'
	import type { ChatSession } from '@/api/ai.uts'
	
	interface TabBarItem {
		pagePath: string
		text: string
		iconPath: string
		selectedIconPath: string
	}
	
	export default {
		data() {
			return {
				inputText: '',
				chatSessions: [] as ChatSession[],
				quickQuestions: [
					'å¦‚ä½•å¼€å§‹ç†è´¢ï¼Ÿ',
					'åŸºé‡‘å’Œè‚¡ç¥¨å“ªä¸ªé£é™©æ›´ä½ï¼Ÿ',
					'ä»€ä¹ˆæ˜¯å¤åˆ©ï¼Ÿ',
					'å¦‚ä½•åšèµ„äº§é…ç½®ï¼Ÿ',
					'å®šæŠ•é€‚åˆæˆ‘å—ï¼Ÿ'
				],
				tabList: [
					{ pagePath: '/pages/home/home', text: 'é¦–é¡µ', iconPath: '/static/tabbar/home.png', selectedIconPath: '/static/tabbar/home-active.png' },
					{ pagePath: '/pages/asset/asset', text: 'èµ„äº§', iconPath: '/static/tabbar/asset.png', selectedIconPath: '/static/tabbar/asset-active.png' },
					{ pagePath: '/pages/ai/ai', text: 'AIåŠ©æ‰‹', iconPath: '/static/tabbar/ai.png', selectedIconPath: '/static/tabbar/ai-active.png' },
					{ pagePath: '/pages/mine/mine', text: 'æˆ‘çš„', iconPath: '/static/tabbar/mine.png', selectedIconPath: '/static/tabbar/mine-active.png' }
				] as TabBarItem[]
			}
		},
		onLoad() {
			this.loadChatSessions()
		},
		onShow() {
			this.loadChatSessions()
		},
		methods: {
			async loadChatSessions() {
				try {
					const res = await getChatSessions()
					this.chatSessions = res.data.slice(0, 3)
				} catch (e) {
					console.error('è·å–å¯¹è¯åˆ—è¡¨å¤±è´¥:', e)
				}
			},
			
			formatTime(time: string): string {
				return getRelativeTime(time)
			},
			
			startChat() {
				if (!this.inputText.trim()) {
					uni.showToast({ title: 'è¯·è¾“å…¥é—®é¢˜', icon: 'none' })
					return
				}
				uni.navigateTo({
					url: `/pages/ai-chat/ai-chat?question=${encodeURIComponent(this.inputText)}`
				})
				this.inputText = ''
			},
			
			askQuestion(question: string) {
				uni.navigateTo({
					url: `/pages/ai-chat/ai-chat?question=${encodeURIComponent(question)}`
				})
			},
			
			startVoiceInput() {
				uni.showToast({ title: 'è¯­éŸ³è¾“å…¥å¼€å‘ä¸­', icon: 'none' })
			},
			
			goToChat() {
				uni.navigateTo({ url: '/pages/ai-chat/ai-chat' })
			},
			
			goToPlan() {
				uni.navigateTo({ url: '/pages/finance-plan/finance-plan' })
			},
			
			goToRecommend() {
				uni.navigateTo({ url: '/pages/recommend/recommend' })
			},
			
			goToRiskAssess() {
				uni.navigateTo({ url: '/pages/risk-assess/risk-assess' })
			},
			
			goToChatHistory() {
				uni.navigateTo({ url: '/pages/chat-history/chat-history' })
			},
			
			goToChatDetail(sessionId: string) {
				uni.navigateTo({ url: `/pages/ai-chat/ai-chat?sessionId=${sessionId}` })
			}
		}
	}
</script>
