<template>
	<view class="change-pwd-page">
		<sg-navbar title="ä¿®æ”¹ç™»å½•å¯†ç " />
		
		<view class="change-pwd-form">
			<view class="change-pwd-field">
				<text class="change-pwd-label">åŸå¯†ç ?/text>
				<view class="change-pwd-input-wrap">
					<input 
						class="change-pwd-input"
						v-model="oldPassword"
						placeholder="è¯·è¾“å…¥åŸå¯†ç "
						:password="!showOld"
						type="text"
					/>
					<view class="change-pwd-eye" @click="showOld = !showOld">
						<text>{{ showOld ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—? }}</text>
					</view>
				</view>
			</view>
			
			<view class="change-pwd-field">
				<text class="change-pwd-label">æ–°å¯†ç ?/text>
				<view class="change-pwd-input-wrap">
					<input 
						class="change-pwd-input"
						v-model="newPassword"
						placeholder="6-64ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­?
						:password="!showNew"
						type="text"
					/>
					<view class="change-pwd-eye" @click="showNew = !showNew">
						<text>{{ showNew ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—? }}</text>
					</view>
				</view>
				<view class="change-pwd-strength" v-if="newPassword">
					<view class="strength-bar">
						<view class="strength-fill" :style="{ width: strengthWidth, backgroundColor: strengthColor }"></view>
					</view>
					<text class="strength-text" :style="{ color: strengthColor }">{{ strengthText }}</text>
				</view>
			</view>
			
			<view class="change-pwd-field">
				<text class="change-pwd-label">ç¡®è®¤æ–°å¯†ç ?/text>
				<view class="change-pwd-input-wrap">
					<input 
						class="change-pwd-input"
						v-model="confirmPassword"
						placeholder="è¯·å†æ¬¡è¾“å…¥æ–°å¯†ç "
						:password="true"
						type="text"
					/>
				</view>
			</view>
		</view>
		
		<view class="change-pwd-tips">
			<text class="change-pwd-tips-title">å¯†ç è®¾ç½®å»ºè®®ï¼?/text>
			<text class="change-pwd-tips-item">â€?å¯†ç é•¿åº¦6-64ä½?/text>
			<text class="change-pwd-tips-item">â€?å¿…é¡»åŒ…å«å­—æ¯å’Œæ•°å­?/text>
			<text class="change-pwd-tips-item">â€?å»ºè®®åŒ…å«å¤§å°å†™å­—æ¯å’Œç‰¹æ®Šå­—ç¬¦</text>
			<text class="change-pwd-tips-item">â€?ä¸è¦ä½¿ç”¨ä¸å…¶ä»–ç½‘ç«™ç›¸åŒçš„å¯†ç </text>
		</view>
		
		<view 
			class="change-pwd-btn" 
			:class="{ 'change-pwd-btn--disabled': !canSubmit }"
			@click="changePassword"
		>
			<text class="change-pwd-btn-text">ç¡®è®¤ä¿®æ”¹</text>
		</view>
	</view>
</template>

<script lang="uts">
	import { changePassword } from '@/api/auth.uts'
	import { isValidPassword } from '@/utils/validate.uts'
	import { getStorage } from '@/utils/storage.uts'
	import { USER_INFO_KEY } from '@/config/index.uts'
	
	export default {
		data() {
			return {
				oldPassword: '',
				newPassword: '',
				confirmPassword: '',
				showOld: false,
				showNew: false
			}
		},
		computed: {
			canSubmit(): boolean {
				return this.oldPassword.length > 0 &&
					isValidPassword(this.newPassword) &&
					this.newPassword === this.confirmPassword
			},
			passwordStrength(): number {
				const pwd = this.newPassword
				if (!pwd) return 0
				
				let score = 0
				if (pwd.length >= 6) score += 1
				if (pwd.length >= 10) score += 1
				if (/[A-Z]/.test(pwd)) score += 1
				if (/[a-z]/.test(pwd)) score += 1
				if (/\d/.test(pwd)) score += 1
				if (/[!@#$%^&*(),.?":{}|<>]/.test(pwd)) score += 1
				
				return Math.min(score, 5)
			},
			strengthWidth(): string {
				return (this.passwordStrength / 5 * 100) + '%'
			},
			strengthColor(): string {
				const colors = ['#ff4d4f', '#fa8c16', '#faad14', '#52c41a', '#1890ff']
				return colors[Math.max(0, this.passwordStrength - 1)] || '#ff4d4f'
			},
			strengthText(): string {
				const texts = ['å¼?, 'è¾ƒå¼±', 'ä¸€èˆ?, 'å¼?, 'å¾ˆå¼º']
				return texts[Math.max(0, this.passwordStrength - 1)] || 'å¼?
			}
		},
		methods: {
			async changePassword() {
				if (!this.canSubmit) {
					if (!this.oldPassword) {
						uni.showToast({ title: 'è¯·è¾“å…¥åŸå¯†ç ', icon: 'none' })
					} else if (!isValidPassword(this.newPassword)) {
						uni.showToast({ title: 'æ–°å¯†ç æ ¼å¼ä¸æ­£ç¡®', icon: 'none' })
					} else if (this.newPassword !== this.confirmPassword) {
						uni.showToast({ title: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡?, icon: 'none' })
					}
					return
				}
				
				try {
					const userInfo = getStorage<any>(USER_INFO_KEY)
					const userId = userInfo?.userId || 0
					
					await changePassword(userId, {
						oldPassword: this.oldPassword,
						newPassword: this.newPassword
					})
					
					uni.showToast({ title: 'å¯†ç ä¿®æ”¹æˆåŠŸ', icon: 'success' })
					setTimeout(() => {
						uni.navigateBack()
					}, 1500)
				} catch (e) {
					console.error('ä¿®æ”¹å¯†ç å¤±è´¥:', e)
				}
			}
		}
	}
</script>

<style lang="scss">
	@import './change-password.scss';
</style>
