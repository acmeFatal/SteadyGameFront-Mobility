<template>
	<view class="feedback-page">
		<sg-navbar title="æ„è§åé¦ˆ" />
		
		<view class="feedback-form">
			<view class="feedback-section">
				<text class="feedback-label">åé¦ˆç±»å‹</text>
				<view class="feedback-types">
					<view 
						v-for="(type, index) in feedbackTypes" 
						:key="index"
						class="feedback-type"
						:class="{ 'feedback-type--active': selectedType === type.value }"
						@click="selectedType = type.value"
					>
						<text class="feedback-type-icon">{{ type.icon }}</text>
						<text class="feedback-type-text">{{ type.label }}</text>
					</view>
				</view>
			</view>
			
			<view class="feedback-section">
				<text class="feedback-label">é—®é¢˜æè¿°</text>
				<textarea 
					class="feedback-textarea"
					v-model="content"
					placeholder="è¯·è¯¦ç»†æè¿°æ‚¨é‡åˆ°çš„é—®é¢˜æˆ–å»ºè®®ï¼Œä»¥ä¾¿æˆ‘ä»¬æ›´å¥½åœ°ä¸ºæ‚¨æœåŠ¡..."
					maxlength="500"
				></textarea>
				<text class="feedback-count">{{ content.length }}/500</text>
			</view>
			
			<view class="feedback-section">
				<text class="feedback-label">ä¸Šä¼ æˆªå›¾ï¼ˆé€‰å¡«ï¼‰</text>
				<view class="feedback-images">
					<view 
						v-for="(img, index) in images" 
						:key="index"
						class="feedback-image"
					>
						<image class="feedback-image-src" :src="img" mode="aspectFill"></image>
						<view class="feedback-image-delete" @click="removeImage(index)">
							<text class="feedback-image-delete-icon">Ã—</text>
						</view>
					</view>
					<view 
						v-if="images.length < 4" 
						class="feedback-image feedback-image--add"
						@click="addImage"
					>
						<text class="feedback-image-add-icon">+</text>
						<text class="feedback-image-add-text">æ·»åŠ å›¾ç‰‡</text>
					</view>
				</view>
			</view>
			
			<view class="feedback-section">
				<text class="feedback-label">è”ç³»æ–¹å¼ï¼ˆé€‰å¡«ï¼‰</text>
				<input 
					class="feedback-input"
					v-model="contact"
					placeholder="è¯·ç•™ä¸‹æ‚¨çš„æ‰‹æœºå·æˆ–é‚®ç®±ï¼Œæ–¹ä¾¿æˆ‘ä»¬è”ç³»æ‚¨"
				/>
			</view>
		</view>
		
		<view 
			class="feedback-submit" 
			:class="{ 'feedback-submit--disabled': !canSubmit }"
			@click="submitFeedback"
		>
			<text class="feedback-submit-text">æäº¤åé¦ˆ</text>
		</view>
	</view>
</template>

<script lang="uts">
	interface FeedbackType {
		label: string
		value: string
		icon: string
	}
	
	export default {
		data() {
			return {
				selectedType: '',
				content: '',
				images: [] as string[],
				contact: '',
				feedbackTypes: [
					{ label: 'åŠŸèƒ½å»ºè®®', value: 'suggestion', icon: 'ğŸ’¡' },
					{ label: 'é—®é¢˜åé¦ˆ', value: 'bug', icon: 'ğŸ›' },
					{ label: 'ä½“éªŒé—®é¢˜', value: 'experience', icon: 'ğŸ˜•' },
					{ label: 'å…¶ä»–', value: 'other', icon: 'ğŸ“' }
				] as FeedbackType[]
			}
		},
		computed: {
			canSubmit(): boolean {
				return this.selectedType !== '' && this.content.trim().length >= 10
			}
		},
		methods: {
			addImage() {
				uni.chooseImage({
					count: 4 - this.images.length,
					sizeType: ['compressed'],
					sourceType: ['album', 'camera'],
					success: (res) => {
						this.images = [...this.images, ...res.tempFilePaths]
					}
				})
			},
			
			removeImage(index: number) {
				this.images.splice(index, 1)
			},
			
			async submitFeedback() {
				if (!this.canSubmit) {
					if (!this.selectedType) {
						uni.showToast({ title: 'è¯·é€‰æ‹©åé¦ˆç±»å‹', icon: 'none' })
					} else {
						uni.showToast({ title: 'è¯·è¾“å…¥è‡³å°‘10å­—çš„é—®é¢˜æè¿°', icon: 'none' })
					}
					return
				}
				
				try {
					uni.showLoading({ title: 'æäº¤ä¸­...' })
					
					// æ¨¡æ‹Ÿæäº¤
					await new Promise(resolve => setTimeout(resolve, 1500))
					
					uni.hideLoading()
					uni.showToast({ title: 'æ„Ÿè°¢æ‚¨çš„åé¦ˆ', icon: 'success' })
					
					setTimeout(() => {
						uni.navigateBack()
					}, 1500)
				} catch (e) {
					uni.hideLoading()
					console.error('æäº¤åé¦ˆå¤±è´¥:', e)
				}
			}
		}
	}
</script>
