<template>
	<view class="plan-page">
		<sg-navbar title="ç†è´¢è§„åˆ’" />
		
		<view class="plan-form">
			<view class="plan-section">
				<text class="plan-section-title">ç†è´¢ç›®æ ‡</text>
				<view class="plan-goals">
					<view 
						v-for="(goal, index) in goals" 
						:key="index"
						class="plan-goal"
						:class="{ 'plan-goal--active': selectedGoal === goal.value }"
						@click="selectedGoal = goal.value"
					>
						<text class="plan-goal-icon">{{ goal.icon }}</text>
						<text class="plan-goal-text">{{ goal.label }}</text>
					</view>
				</view>
			</view>
			
			<view class="plan-section">
				<text class="plan-section-title">åˆå§‹æŠ•å…¥èµ„é‡‘</text>
				<view class="plan-input-wrap">
					<text class="plan-input-prefix">Â¥</text>
					<input 
						class="plan-input"
						type="digit"
						v-model="initialCapital"
						placeholder="è¯·è¾“å…¥åˆå§‹æŠ•å…¥é‡‘é¢"
					/>
				</view>
			</view>
			
			<view class="plan-section">
				<text class="plan-section-title">æ¯æœˆå®šæŠ•é‡‘é¢</text>
				<view class="plan-input-wrap">
					<text class="plan-input-prefix">Â¥</text>
					<input 
						class="plan-input"
						type="digit"
						v-model="monthlyInvestment"
						placeholder="è¯·è¾“å…¥æ¯æœˆæŠ•å…¥é‡‘é¢"
					/>
				</view>
			</view>
			
			<view class="plan-section">
				<text class="plan-section-title">æŠ•èµ„æœŸé™</text>
				<view class="plan-periods">
					<view 
						v-for="(period, index) in periods" 
						:key="index"
						class="plan-period"
						:class="{ 'plan-period--active': selectedPeriod === period.value }"
						@click="selectedPeriod = period.value"
					>
						<text class="plan-period-text">{{ period.label }}</text>
					</view>
				</view>
			</view>
			
			<view class="plan-section">
				<text class="plan-section-title">é£é™©åå¥½</text>
				<view class="plan-risks">
					<view 
						v-for="(risk, index) in risks" 
						:key="index"
						class="plan-risk"
						:class="{ 'plan-risk--active': selectedRisk === risk.value }"
						@click="selectedRisk = risk.value"
					>
						<text class="plan-risk-text">{{ risk.label }}</text>
					</view>
				</view>
			</view>
		</view>
		
		<view class="plan-submit" @click="generatePlan">
			<text class="plan-submit-text">ç”Ÿæˆç†è´¢æ–¹æ¡ˆ</text>
		</view>
		
		<view v-if="planResult" class="plan-result">
			<view class="plan-result-header">
				<text class="plan-result-title">{{ planResult.title }}</text>
				<text class="plan-result-goal">ç›®æ ‡ï¼š{{ planResult.goal }}</text>
			</view>
			
			<view class="plan-result-summary">
				<view class="plan-result-item">
					<text class="plan-result-value">Â¥{{ formatMoney(totalInvestment) }}</text>
					<text class="plan-result-label">æ€»æŠ•å…¥</text>
				</view>
				<view class="plan-result-item">
					<text class="plan-result-value text-rise">Â¥{{ formatMoney(expectedTotal) }}</text>
					<text class="plan-result-label">é¢„æœŸæ€»é¢</text>
				</view>
				<view class="plan-result-item">
					<text class="plan-result-value text-rise">{{ (planResult.expectedReturn * 100).toFixed(1) }}%</text>
					<text class="plan-result-label">é¢„æœŸå¹´åŒ–</text>
				</view>
			</view>
			
			<view class="plan-portfolio">
				<text class="plan-portfolio-title">æ¨èé…ç½®</text>
				<view class="plan-portfolio-list">
					<view 
						v-for="(item, index) in planResult.portfolios" 
						:key="index"
						class="plan-portfolio-item"
					>
						<view class="plan-portfolio-bar" :style="{ width: item.percentage + '%', backgroundColor: getColor(index) }"></view>
						<text class="plan-portfolio-name">{{ item.name }}</text>
						<text class="plan-portfolio-percent">{{ item.percentage }}%</text>
					</view>
				</view>
			</view>
			
			<view class="plan-result-actions">
				<view class="plan-action-btn plan-action-btn--save" @click="savePlan">
					<text class="plan-action-btn-text">ä¿å­˜æ–¹æ¡ˆ</text>
				</view>
				<view class="plan-action-btn plan-action-btn--execute" @click="executePlan">
					<text class="plan-action-btn-text">ç«‹å³æ‰§è¡Œ</text>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { generateFinancePlan } from '@/api/ai.uts'
	import type { FinancePlan, GeneratePlanParams } from '@/api/ai.uts'
	
	interface Goal {
		label: string
		value: string
		icon: string
	}
	
	interface Period {
		label: string
		value: number
	}
	
	interface Risk {
		label: string
		value: number
	}
	
	const COLORS = ['#1890FF', '#52C41A', '#FAAD14', '#F5222D', '#722ED1']
	
	export default {
		data() {
			return {
				selectedGoal: '',
				initialCapital: '',
				monthlyInvestment: '',
				selectedPeriod: 0,
				selectedRisk: 0,
				planResult: null as FinancePlan | null,
				goals: [
					{ label: 'å…»è€å‚¨è“„', value: 'retirement', icon: 'ğŸ ' },
					{ label: 'å­å¥³æ•™è‚²', value: 'education', icon: 'ğŸ“š' },
					{ label: 'ä¹°æˆ¿é¦–ä»˜', value: 'house', icon: 'ğŸ¡' },
					{ label: 'èµ„äº§å¢å€¼', value: 'growth', icon: 'ğŸ“ˆ' },
					{ label: 'å…¶ä»–ç›®æ ‡', value: 'other', icon: 'ğŸ¯' }
				] as Goal[],
				periods: [
					{ label: '1å¹´', value: 1 },
					{ label: '3å¹´', value: 3 },
					{ label: '5å¹´', value: 5 },
					{ label: '10å¹´', value: 10 },
					{ label: '20å¹´', value: 20 }
				] as Period[],
				risks: [
					{ label: 'ä¿å®ˆ', value: 1 },
					{ label: 'ç¨³å¥', value: 2 },
					{ label: 'å¹³è¡¡', value: 3 },
					{ label: 'ç§¯æ', value: 4 },
					{ label: 'æ¿€è¿›', value: 5 }
				] as Risk[]
			}
		},
		computed: {
			totalInvestment(): number {
				const initial = Number(this.initialCapital) || 0
				const monthly = Number(this.monthlyInvestment) || 0
				const years = this.selectedPeriod || 0
				return initial + monthly * 12 * years
			},
			expectedTotal(): number {
				if (!this.planResult) return 0
				const rate = this.planResult.expectedReturn || 0
				const years = this.selectedPeriod || 0
				return this.totalInvestment * Math.pow(1 + rate, years)
			}
		},
		methods: {
			formatMoney(num: number): string {
				return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
			},
			
			getColor(index: number): string {
				return COLORS[index % COLORS.length]
			},
			
			async generatePlan() {
				if (!this.selectedGoal) {
					uni.showToast({ title: 'è¯·é€‰æ‹©ç†è´¢ç›®æ ‡', icon: 'none' })
					return
				}
				if (!this.initialCapital && !this.monthlyInvestment) {
					uni.showToast({ title: 'è¯·è¾“å…¥æŠ•èµ„é‡‘é¢', icon: 'none' })
					return
				}
				if (!this.selectedPeriod) {
					uni.showToast({ title: 'è¯·é€‰æ‹©æŠ•èµ„æœŸé™', icon: 'none' })
					return
				}
				if (!this.selectedRisk) {
					uni.showToast({ title: 'è¯·é€‰æ‹©é£é™©åå¥½', icon: 'none' })
					return
				}
				
				try {
					uni.showLoading({ title: 'æ­£åœ¨ç”Ÿæˆæ–¹æ¡ˆ...' })
					
					const params: GeneratePlanParams = {
						goal: this.selectedGoal,
						initialCapital: Number(this.initialCapital) || 0,
						monthlyInvestment: Number(this.monthlyInvestment) || 0,
						years: this.selectedPeriod,
						riskLevel: this.selectedRisk
					}
					
					const res = await generateFinancePlan(params)
					this.planResult = res.data
					
					uni.hideLoading()
				} catch (e) {
					uni.hideLoading()
					console.error('ç”Ÿæˆæ–¹æ¡ˆå¤±è´¥:', e)
					
					// æ¨¡æ‹Ÿæ•°æ®
					this.planResult = {
						planId: 1,
						title: 'æ™ºèƒ½ç†è´¢æ–¹æ¡ˆ',
						goal: this.selectedGoal,
						planContent: '',
						portfolios: [
							{ name: 'è´§å¸åŸºé‡‘', percentage: 20 },
							{ name: 'å€ºåˆ¸åŸºé‡‘', percentage: 30 },
							{ name: 'æ··åˆåŸºé‡‘', percentage: 30 },
							{ name: 'è‚¡ç¥¨åŸºé‡‘', percentage: 20 }
						],
						expectedReturn: 0.06 + this.selectedRisk * 0.02,
						status: 'draft',
						createdAt: new Date().toISOString()
					}
				}
			},
			
			savePlan() {
				uni.showToast({ title: 'æ–¹æ¡ˆå·²ä¿å­˜', icon: 'success' })
			},
			
			executePlan() {
				uni.showModal({
					title: 'ç¡®è®¤æ‰§è¡Œ',
					content: 'ç¡®å®šè¦æŒ‰ç…§æ­¤æ–¹æ¡ˆè¿›è¡ŒæŠ•èµ„å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							uni.showToast({ title: 'å·²å¼€å§‹æ‰§è¡Œ', icon: 'success' })
						}
					}
				})
			}
		}
	}
</script>
