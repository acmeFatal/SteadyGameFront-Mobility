<template>
	<view class="forgot-page">
		<sg-navbar title="å¿˜è®°å¯†ç " />
		
		<view class="forgot-steps">
			<view 
				v-for="(step, index) in steps" 
				:key="index"
				class="forgot-step"
				:class="{ 'forgot-step--active': currentStep >= index, 'forgot-step--done': currentStep > index }"
			>
				<view class="forgot-step-dot">
					<text v-if="currentStep > index" class="forgot-step-check">âœ?/text>
					<text v-else class="forgot-step-num">{{ index + 1 }}</text>
				</view>
				<text class="forgot-step-text">{{ step }}</text>
			</view>
		</view>
		
		<view class="forgot-form">
			<view v-if="currentStep === 0" class="forgot-step-content">
				<text class="forgot-title">éªŒè¯èº«ä»½</text>
				<text class="forgot-desc">è¯·è¾“å…¥æ‚¨æ³¨å†Œæ—¶ä½¿ç”¨çš„æ‰‹æœºå·æˆ–é‚®ç®±</text>
				
				<view class="forgot-field">
					<input 
						class="forgot-input"
						v-model="identifier"
						placeholder="æ‰‹æœºå?é‚®ç®±"
						type="text"
					/>
				</view>
				
				<view class="forgot-field">
					<input 
						class="forgot-input forgot-input--code"
						v-model="captcha"
						placeholder="å›¾å½¢éªŒè¯ç ?
						type="text"
						maxlength="4"
					/>
					<image 
						class="forgot-captcha" 
						:src="captchaImage"
						@click="refreshCaptcha"
					></image>
				</view>
				
				<view class="forgot-btn" @click="sendVerifyCode">
					<text class="forgot-btn-text">å‘é€éªŒè¯ç </text>
				</view>
			</view>
			
			<view v-if="currentStep === 1" class="forgot-step-content">
				<text class="forgot-title">è¾“å…¥éªŒè¯ç ?/text>
				<text class="forgot-desc">éªŒè¯ç å·²å‘é€è‡³ {{ maskedIdentifier }}</text>
				
				<view class="forgot-code-inputs">
					<input 
						v-for="(item, index) in 6" 
						:key="index"
						class="forgot-code-input"
						type="number"
						maxlength="1"
						:value="codeArray[index]"
						@input="onCodeInput($event, index)"
					/>
				</view>
				
				<view class="forgot-resend">
					<text class="forgot-resend-text" :class="{ 'forgot-resend-text--disabled': countdown > 0 }" @click="resendCode">
						{{ countdown > 0 ? countdown + 'ç§’åé‡å‘' : 'é‡æ–°å‘é€? }}
					</text>
				</view>
				
				<view class="forgot-btn" :class="{ 'forgot-btn--disabled': verifyCode.length !== 6 }" @click="verifyIdentity">
					<text class="forgot-btn-text">éªŒè¯</text>
				</view>
			</view>
			
			<view v-if="currentStep === 2" class="forgot-step-content">
				<text class="forgot-title">è®¾ç½®æ–°å¯†ç ?/text>
				<text class="forgot-desc">è¯·è®¾ç½®æ‚¨çš„æ–°ç™»å½•å¯†ç </text>
				
				<view class="forgot-field">
					<input 
						class="forgot-input"
						v-model="newPassword"
						placeholder="æ–°å¯†ç ï¼ˆ6-64ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­—ï¼‰"
						:password="!showPassword"
						type="text"
					/>
					<view class="forgot-eye" @click="showPassword = !showPassword">
						<text>{{ showPassword ? 'ğŸ‘' : 'ğŸ‘â€ğŸ—? }}</text>
					</view>
				</view>
				
				<view class="forgot-field">
					<input 
						class="forgot-input"
						v-model="confirmPassword"
						placeholder="ç¡®è®¤æ–°å¯†ç ?
						:password="true"
						type="text"
					/>
				</view>
				
				<view class="forgot-btn" :class="{ 'forgot-btn--disabled': !canReset }" @click="resetPassword">
					<text class="forgot-btn-text">é‡ç½®å¯†ç </text>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getCaptcha, forgotPasswordRequest, forgotPasswordReset } from '@/api/auth.uts'
	import { isValidPhone, isValidEmail, isValidPassword } from '@/utils/validate.uts'
	import { formatPhone, formatEmail } from '@/utils/format.uts'
	
	export default {
		data() {
			return {
				currentStep: 0,
				steps: ['éªŒè¯èº«ä»½', 'è¾“å…¥éªŒè¯ç ?, 'é‡ç½®å¯†ç '],
				identifier: '',
				captcha: '',
				captchaId: '',
				captchaImage: '',
				verifyCode: '',
				codeArray: ['', '', '', '', '', ''],
				countdown: 0,
				newPassword: '',
				confirmPassword: '',
				showPassword: false
			}
		},
		computed: {
			maskedIdentifier(): string {
				if (isValidPhone(this.identifier)) {
					return formatPhone(this.identifier)
				}
				if (isValidEmail(this.identifier)) {
					return formatEmail(this.identifier)
				}
				return this.identifier
			},
			canReset(): boolean {
				return isValidPassword(this.newPassword) && 
					this.newPassword === this.confirmPassword
			}
		},
		onLoad() {
			this.refreshCaptcha()
		},
		methods: {
			async refreshCaptcha() {
				try {
					const res = await getCaptcha()
					this.captchaId = res.data.captchaId
					this.captchaImage = res.data.captchaImage
				} catch (e) {
					console.error('è·å–éªŒè¯ç å¤±è´?', e)
				}
			},
			
			async sendVerifyCode() {
				if (!this.identifier) {
					uni.showToast({ title: 'è¯·è¾“å…¥æ‰‹æœºå·æˆ–é‚®ç®?, icon: 'none' })
					return
				}
				if (!isValidPhone(this.identifier) && !isValidEmail(this.identifier)) {
					uni.showToast({ title: 'è¯·è¾“å…¥æ­£ç¡®çš„æ‰‹æœºå·æˆ–é‚®ç®±', icon: 'none' })
					return
				}
				if (!this.captcha) {
					uni.showToast({ title: 'è¯·è¾“å…¥å›¾å½¢éªŒè¯ç ', icon: 'none' })
					return
				}
				
				try {
					await forgotPasswordRequest(this.identifier)
					uni.showToast({ title: 'éªŒè¯ç å·²å‘é€?, icon: 'success' })
					this.currentStep = 1
					this.startCountdown()
				} catch (e) {
					console.error('å‘é€éªŒè¯ç å¤±è´¥:', e)
				}
			},
			
			startCountdown() {
				this.countdown = 60
				const timer = setInterval(() => {
					this.countdown--
					if (this.countdown <= 0) {
						clearInterval(timer)
					}
				}, 1000)
			},
			
			resendCode() {
				if (this.countdown > 0) return
				this.sendVerifyCode()
			},
			
			onCodeInput(e: any, index: number) {
				const value = e.detail.value
				this.codeArray[index] = value
				this.verifyCode = this.codeArray.join('')
			},
			
			verifyIdentity() {
				if (this.verifyCode.length !== 6) {
					uni.showToast({ title: 'è¯·è¾“å…?ä½éªŒè¯ç ', icon: 'none' })
					return
				}
				this.currentStep = 2
			},
			
			async resetPassword() {
				if (!this.canReset) {
					if (!isValidPassword(this.newPassword)) {
						uni.showToast({ title: 'å¯†ç éœ€6-64ä½ï¼ŒåŒ…å«å­—æ¯å’Œæ•°å­?, icon: 'none' })
					} else {
						uni.showToast({ title: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡?, icon: 'none' })
					}
					return
				}
				
				try {
					await forgotPasswordReset({
						identifier: this.identifier,
						code: this.verifyCode,
						newPassword: this.newPassword
					})
					
					uni.showToast({ title: 'å¯†ç é‡ç½®æˆåŠŸ', icon: 'success' })
					setTimeout(() => {
						uni.navigateBack()
					}, 1500)
				} catch (e) {
					console.error('é‡ç½®å¯†ç å¤±è´¥:', e)
				}
			}
		}
	}
</script>

<style lang="scss">
	@import './forgot-password.scss';
</style>
