<template>
	<view class="home-page">
		<view class="home-header">
			<view class="home-user" @click="handleUserClick">
				<image class="home-avatar" :src="userInfo.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
				<view class="home-user-info">
					<text class="home-username">{{ userInfo.realName || userInfo.username || 'ç‚¹å‡»ç™»å½•' }}</text>
					<text class="home-greeting">{{ greeting }}</text>
				</view>
			</view>
			<view class="home-actions">
				<view class="home-action" @click="goToMessage">
					<text class="home-action-icon">ğŸ””</text>
					<view v-if="unreadCount > 0" class="home-badge">
						<text class="home-badge-text">{{ unreadCount > 99 ? '99+' : unreadCount }}</text>
					</view>
				</view>
			</view>
		</view>
		
		<!-- æœªç™»å½•æç¤º -->
		<view v-if="!isLoggedIn" class="home-login-tip" @click="goToLogin">
			<text class="home-login-tip-icon">ğŸ”</text>
			<view class="home-login-tip-content">
				<text class="home-login-tip-title">ç™»å½•åæŸ¥çœ‹æ‚¨çš„èµ„äº§</text>
				<text class="home-login-tip-desc">äº«å—AIæ™ºèƒ½ç†è´¢æ¨èã€èµ„äº§ç®¡ç†ç­‰æœåŠ¡</text>
			</view>
			<text class="home-login-tip-arrow">â€º</text>
		</view>
		
		<!-- å·²ç™»å½•æ˜¾ç¤ºèµ„äº§å¡ç‰‡ -->
		<sg-asset-card
			v-if="isLoggedIn"
			class="home-asset-card"
			:amount="assetOverview.totalAssets"
			:earnings="assetOverview.dailyEarnings"
			@click="goToAsset"
		/>
		
		<view class="home-quick-actions">
			<view class="home-quick-item" @click="goToTransfer">
				<view class="home-quick-icon-wrap">
					<text class="home-quick-icon">ğŸ’°</text>
				</view>
				<text class="home-quick-text">è½¬å…¥</text>
			</view>
			<view class="home-quick-item" @click="goToWithdraw">
				<view class="home-quick-icon-wrap">
					<text class="home-quick-icon">ğŸ’³</text>
				</view>
				<text class="home-quick-text">è½¬å‡º</text>
			</view>
			<view class="home-quick-item" @click="goToProducts">
				<view class="home-quick-icon-wrap">
					<text class="home-quick-icon">ğŸ“Š</text>
				</view>
				<text class="home-quick-text">ç†è´¢äº§å“</text>
			</view>
			<view class="home-quick-item" @click="goToAIChat">
				<view class="home-quick-icon-wrap">
					<text class="home-quick-icon">ğŸ¤–</text>
				</view>
				<text class="home-quick-text">AIåŠ©æ‰‹</text>
			</view>
		</view>
		
		<sg-card title="æ™ºèƒ½æ¨è" extra="æŸ¥çœ‹æ›´å¤š" @extraClick="goToRecommend">
			<view class="home-recommend-list">
				<view 
					v-for="(item, index) in recommendations" 
					:key="index"
					class="home-recommend-item"
					@click="goToProductDetail(item.productId)"
				>
					<view class="home-recommend-info">
						<text class="home-recommend-name">{{ item.productName }}</text>
						<text class="home-recommend-tag">{{ getRiskLevelText(item.riskLevel) }}</text>
					</view>
					<view class="home-recommend-rate">
						<text class="home-recommend-rate-value">{{ (item.expectedReturn * 100).toFixed(2) }}%</text>
						<text class="home-recommend-rate-label">é¢„æœŸå¹´åŒ–</text>
					</view>
				</view>
				<sg-empty v-if="recommendations.length === 0" text="æš‚æ— æ¨è" />
			</view>
		</sg-card>
		
		<sg-card title="å¸‚åœºè¡Œæƒ…" extra="æ›´å¤š" @extraClick="goToMarket">
			<view class="home-market-list">
				<view class="home-market-item" v-for="(item, index) in marketData" :key="index">
					<text class="home-market-name">{{ item.name }}</text>
					<text class="home-market-value">{{ item.value }}</text>
					<text 
						class="home-market-change"
						:class="item.change >= 0 ? 'text-rise' : 'text-fall'"
					>{{ item.change >= 0 ? '+' : '' }}{{ item.change }}%</text>
				</view>
			</view>
		</sg-card>
		
		<sg-tabbar :current="0" :list="tabList" />
	</view>
</template>

<script lang="uts">
	import { getAssetOverview } from '@/api/asset.uts'
	import { getAIRecommendations } from '@/api/ai.uts'
	import { getStorage } from '@/utils/storage.uts'
	import { USER_INFO_KEY, TOKEN_KEY, RISK_LEVEL_MAP } from '@/config/index.uts'
	import type { AssetOverview } from '@/api/asset.uts'
	import type { AIRecommendProduct } from '@/api/ai.uts'
	
	interface UserInfo {
		userId: number
		username: string
		realName: string
		avatar: string
		roles: string[]
	}
	
	interface MarketItem {
		name: string
		value: string
		change: number
	}
	
	interface TabBarItem {
		pagePath: string
		text: string
		iconPath: string
		selectedIconPath: string
	}
	
	export default {
		data() {
			return {
				isLoggedIn: false,
				userInfo: {} as UserInfo,
				unreadCount: 0,
				assetOverview: {
					totalAssets: 0,
					dailyEarnings: 0
				} as AssetOverview,
				recommendations: [] as AIRecommendProduct[],
				marketData: [
					{ name: 'ä¸Šè¯æŒ‡æ•°', value: '3150.50', change: 0.85 },
					{ name: 'æ·±è¯æˆæŒ‡', value: '10250.30', change: -0.32 },
					{ name: 'åˆ›ä¸šæ¿æŒ‡', value: '2050.80', change: 1.25 }
				] as MarketItem[],
				tabList: [
					{ pagePath: '/pages/home/home', text: 'é¦–é¡µ', iconPath: '/static/tabbar/home.png', selectedIconPath: '/static/tabbar/home-active.png' },
					{ pagePath: '/pages/asset/asset', text: 'èµ„äº§', iconPath: '/static/tabbar/asset.png', selectedIconPath: '/static/tabbar/asset-active.png' },
					{ pagePath: '/pages/ai/ai', text: 'AIåŠ©æ‰‹', iconPath: '/static/tabbar/ai.png', selectedIconPath: '/static/tabbar/ai-active.png' },
					{ pagePath: '/pages/mine/mine', text: 'æˆ‘çš„', iconPath: '/static/tabbar/mine.png', selectedIconPath: '/static/tabbar/mine-active.png' }
				] as TabBarItem[]
			}
		},
		computed: {
			greeting(): string {
				const hour = new Date().getHours()
				if (hour < 6) return 'å‡Œæ™¨å¥½'
				if (hour < 9) return 'æ—©ä¸Šå¥½'
				if (hour < 12) return 'ä¸Šåˆå¥½'
				if (hour < 14) return 'ä¸­åˆå¥½'
				if (hour < 17) return 'ä¸‹åˆå¥½'
				if (hour < 19) return 'å‚æ™šå¥½'
				return 'æ™šä¸Šå¥½'
			}
		},
		onLoad() {
			this.checkLoginStatus()
		},
		onShow() {
			this.checkLoginStatus()
		},
		methods: {
			checkLoginStatus() {
				const token = getStorage<string>(TOKEN_KEY)
				const userInfo = getStorage<UserInfo>(USER_INFO_KEY)
				
				if (token != null && userInfo != null) {
					this.isLoggedIn = true
					this.userInfo = userInfo
					this.loadAssetOverview()
					this.loadRecommendations()
				} else {
					this.isLoggedIn = false
					this.userInfo = {} as UserInfo
				}
			},
			
			async loadAssetOverview() {
				try {
					const res = await getAssetOverview()
					this.assetOverview = res.data
				} catch (e) {
					console.error('è·å–èµ„äº§æ¦‚è§ˆå¤±è´¥:', e)
				}
			},
			
			async loadRecommendations() {
				try {
					const res = await getAIRecommendations(3)
					this.recommendations = res.data
				} catch (e) {
					console.error('è·å–æ¨èå¤±è´¥:', e)
				}
			},
			
			getRiskLevelText(level: number): string {
				return RISK_LEVEL_MAP[level] || 'æœªçŸ¥'
			},
			
			goToMessage() {
				uni.navigateTo({ url: '/pages/message/message' })
			},
			
			goToAsset() {
				uni.switchTab({ url: '/pages/asset/asset' })
			},
			
			goToTransfer() {
				uni.navigateTo({ url: '/pages/transfer/transfer' })
			},
			
			goToWithdraw() {
				uni.navigateTo({ url: '/pages/withdraw/withdraw' })
			},
			
			goToProducts() {
				uni.navigateTo({ url: '/pages/products/products' })
			},
			
			goToAIChat() {
				uni.switchTab({ url: '/pages/ai/ai' })
			},
			
			goToRecommend() {
				uni.navigateTo({ url: '/pages/recommend/recommend' })
			},
			
			goToProductDetail(productId: number) {
				uni.navigateTo({ url: `/pages/product-detail/product-detail?id=${productId}` })
			},
			
			goToMarket() {
				uni.navigateTo({ url: '/pages/market/market' })
			},
			
			goToLogin() {
				uni.navigateTo({ url: '/pages/login/login' })
			},
			
			handleUserClick() {
				if (!this.isLoggedIn) {
					this.goToLogin()
				}
			}
		}
	}
</script>
