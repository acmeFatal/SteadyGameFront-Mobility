<template>
	<view class="mine-page">
		<view class="mine-header">
			<view class="mine-user" @click="goToProfile">
				<image class="mine-avatar" :src="userInfo.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
				<view class="mine-user-info">
					<text class="mine-username">{{ userInfo.realName || userInfo.username || 'è¯·ç™»å½•' }}</text>
					<view class="mine-verify" v-if="userInfo.userId">
						<text class="mine-verify-tag" :class="userInfo.phoneVerified ? 'mine-verify-tag--success' : ''">
							{{ userInfo.phoneVerified ? 'âœ“ æ‰‹æœºå·²éªŒè¯' : 'æ‰‹æœºæœªéªŒè¯' }}
						</text>
					</view>
				</view>
				<text class="mine-arrow">â€º</text>
			</view>
			
			<view class="mine-stats">
				<view class="mine-stat" @click="goToRiskLevel">
					<text class="mine-stat-value">{{ riskLevelText }}</text>
					<text class="mine-stat-label">é£é™©ç­‰çº§</text>
				</view>
				<view class="mine-stat" @click="goToOrders">
					<text class="mine-stat-value">{{ orderCount }}</text>
					<text class="mine-stat-label">äº¤æ˜“è®¢å•</text>
				</view>
				<view class="mine-stat" @click="goToAdvisor">
					<text class="mine-stat-value">{{ hasAdvisor ? 'å·²ç»‘å®š' : 'æœªç»‘å®š' }}</text>
					<text class="mine-stat-label">ä¸“å±é¡¾é—®</text>
				</view>
			</view>
		</view>
		
		<view class="mine-menu">
			<view class="mine-menu-group">
				<sg-list-item 
					title="æˆ‘çš„è®¢å•" 
					icon="ğŸ“‹" 
					@click="goToOrders"
				/>
				<sg-list-item 
					title="èµ„äº§æ˜ç»†" 
					icon="ğŸ’°" 
					@click="goToAssetDetail"
				/>
				<sg-list-item 
					title="äº¤æ˜“æµæ°´" 
					icon="ğŸ“Š" 
					@click="goToTransactions"
				/>
			</view>
			
			<view class="mine-menu-group">
				<sg-list-item 
					title="æˆ‘çš„é¡¾é—®" 
					icon="ğŸ‘¨â€ğŸ’¼" 
					@click="goToAdvisor"
				/>
				<sg-list-item 
					title="ç†è´¢æ–¹æ¡ˆ" 
					icon="ğŸ“‘" 
					@click="goToPlans"
				/>
				<sg-list-item 
					title="é£é™©è¯„ä¼°" 
					icon="âš–ï¸" 
					@click="goToRiskAssess"
				/>
			</view>
			
			<view class="mine-menu-group">
				<sg-list-item 
					title="è´¦å·å®‰å…¨" 
					icon="ğŸ”" 
					@click="goToSecurity"
				/>
				<sg-list-item 
					title="æ¶ˆæ¯é€šçŸ¥" 
					icon="ğŸ””" 
					@click="goToNotification"
				/>
				<sg-list-item 
					title="å¸®åŠ©ä¸­å¿ƒ" 
					icon="â“" 
					@click="goToHelp"
				/>
				<sg-list-item 
					title="å…³äºæˆ‘ä»¬" 
					icon="â„¹ï¸" 
					:border="false"
					@click="goToAbout"
				/>
			</view>
		</view>
		
		<view class="mine-logout" v-if="userInfo.userId" @click="handleLogout">
			<text class="mine-logout-text">é€€å‡ºç™»å½•</text>
		</view>
		
		<sg-tabbar :current="3" :list="tabList" />
	</view>
</template>

<script lang="uts">
	import { logout } from '@/api/auth.uts'
	import { getLatestRiskAssessment } from '@/api/user.uts'
	import { getStorage, removeStorage } from '@/utils/storage.uts'
	import { TOKEN_KEY, REFRESH_TOKEN_KEY, USER_INFO_KEY, RISK_LEVEL_MAP } from '@/config/index.uts'
	
	interface UserInfo {
		userId: number
		username: string
		realName: string
		avatar: string
		phoneVerified: boolean
		roles: string[]
	}
	
	interface TabBarItem {
		pagePath: string
		text: string
		iconPath: string
		selectedIconPath: string
	}
	
	export default {
		data() {
			return {
				userInfo: {} as UserInfo,
				riskLevel: 0,
				orderCount: 0,
				hasAdvisor: false,
				tabList: [
					{ pagePath: '/pages/home/home', text: 'é¦–é¡µ', iconPath: '/static/tabbar/home.png', selectedIconPath: '/static/tabbar/home-active.png' },
					{ pagePath: '/pages/asset/asset', text: 'èµ„äº§', iconPath: '/static/tabbar/asset.png', selectedIconPath: '/static/tabbar/asset-active.png' },
					{ pagePath: '/pages/ai/ai', text: 'AIåŠ©æ‰‹', iconPath: '/static/tabbar/ai.png', selectedIconPath: '/static/tabbar/ai-active.png' },
					{ pagePath: '/pages/mine/mine', text: 'æˆ‘çš„', iconPath: '/static/tabbar/mine.png', selectedIconPath: '/static/tabbar/mine-active.png' }
				] as TabBarItem[]
			}
		},
		computed: {
			riskLevelText(): string {
				if (!this.riskLevel) return 'æœªè¯„ä¼°'
				return RISK_LEVEL_MAP[this.riskLevel] || 'æœªçŸ¥'
			}
		},
		onLoad() {
			this.loadUserInfo()
			this.loadRiskLevel()
		},
		onShow() {
			this.loadUserInfo()
		},
		methods: {
			loadUserInfo() {
				const userInfo = getStorage<UserInfo>(USER_INFO_KEY)
				if (userInfo) {
					this.userInfo = userInfo
				}
			},
			
			async loadRiskLevel() {
				try {
					const res = await getLatestRiskAssessment()
					this.riskLevel = res.data?.riskLevel || 0
				} catch (e) {
					console.error('è·å–é£é™©ç­‰çº§å¤±è´¥:', e)
				}
			},
			
			async handleLogout() {
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®å®šè¦é€€å‡ºç™»å½•å—ï¼Ÿ',
					success: async (res) => {
						if (res.confirm) {
							try {
								if (this.userInfo.userId) {
									await logout(this.userInfo.userId)
								}
							} catch (e) {
								console.error('ç™»å‡ºå¤±è´¥:', e)
							} finally {
								removeStorage(TOKEN_KEY)
								removeStorage(REFRESH_TOKEN_KEY)
								removeStorage(USER_INFO_KEY)
								uni.reLaunch({ url: '/pages/login/login' })
							}
						}
					}
				})
			},
			
			goToProfile() {
				if (!this.userInfo.userId) {
					uni.navigateTo({ url: '/pages/login/login' })
					return
				}
				uni.navigateTo({ url: '/pages/profile/profile' })
			},
			
			goToRiskLevel() {
				uni.navigateTo({ url: '/pages/risk-assess/risk-assess' })
			},
			
			goToOrders() {
				uni.navigateTo({ url: '/pages/orders/orders' })
			},
			
			goToAdvisor() {
				uni.navigateTo({ url: '/pages/my-advisor/my-advisor' })
			},
			
			goToAssetDetail() {
				uni.navigateTo({ url: '/pages/asset-detail/asset-detail' })
			},
			
			goToTransactions() {
				uni.navigateTo({ url: '/pages/transactions/transactions' })
			},
			
			goToPlans() {
				uni.navigateTo({ url: '/pages/my-plans/my-plans' })
			},
			
			goToRiskAssess() {
				uni.navigateTo({ url: '/pages/risk-assess/risk-assess' })
			},
			
			goToSecurity() {
				uni.navigateTo({ url: '/pages/security/security' })
			},
			
			goToNotification() {
				uni.navigateTo({ url: '/pages/notification-setting/notification-setting' })
			},
			
			goToHelp() {
				uni.navigateTo({ url: '/pages/help/help' })
			},
			
			goToAbout() {
				uni.navigateTo({ url: '/pages/about/about' })
			}
		}
	}
</script>

<style lang="scss">
	@import './mine.scss';
</style>
