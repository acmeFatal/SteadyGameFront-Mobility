<template>
	<view class="order-detail-page">
		<sg-navbar title="è®¢å•è¯¦æƒ…" />
		
		<view class="order-status-card" :class="getStatusCardClass(order.orderStatus)">
			<view class="order-status-icon">
				<text class="order-status-icon-text">{{ getStatusIcon(order.orderStatus) }}</text>
			</view>
			<text class="order-status-text">{{ getStatusText(order.orderStatus) }}</text>
			<text class="order-status-desc">{{ getStatusDesc(order.orderStatus) }}</text>
		</view>
		
		<view class="order-product">
			<text class="order-product-title">äº§å“ä¿¡æ¯</text>
			<view class="order-product-info">
				<text class="order-product-name">{{ productInfo.productName || 'ç†è´¢äº§å“' }}</text>
				<text class="order-product-type">{{ getOrderTypeText(order.orderType) }}</text>
			</view>
		</view>
		
		<view class="order-info-card">
			<text class="order-info-title">è®¢å•ä¿¡æ¯</text>
			<view class="order-info-list">
				<view class="order-info-item">
					<text class="order-info-label">è®¢å•ç¼–å·</text>
					<view class="order-info-value-wrap">
						<text class="order-info-value">{{ order.orderNo }}</text>
						<text class="order-info-copy" @click="copyOrderNo">å¤åˆ¶</text>
					</view>
				</view>
				<view class="order-info-item">
					<text class="order-info-label">äº¤æ˜“é‡‘é¢</text>
					<text class="order-info-value order-info-value--amount">Â¥{{ formatMoney(order.amount) }}</text>
				</view>
				<view class="order-info-item">
					<text class="order-info-label">æ‰‹ç»­è´?/text>
					<text class="order-info-value">Â¥{{ formatMoney(order.fee) }}</text>
				</view>
				<view class="order-info-item">
					<text class="order-info-label">åˆ›å»ºæ—¶é—´</text>
					<text class="order-info-value">{{ formatTime(order.createdAt) }}</text>
				</view>
				<view class="order-info-item">
					<text class="order-info-label">æ›´æ–°æ—¶é—´</text>
					<text class="order-info-value">{{ formatTime(order.updatedAt) }}</text>
				</view>
			</view>
		</view>
		
		<view class="order-timeline" v-if="timeline.length > 0">
			<text class="order-timeline-title">è®¢å•è¿›åº¦</text>
			<view class="timeline-list">
				<view 
					v-for="(item, index) in timeline" 
					:key="index"
					class="timeline-item"
					:class="{ 'timeline-item--active': index === 0 }"
				>
					<view class="timeline-dot"></view>
					<view class="timeline-content">
						<text class="timeline-text">{{ item.text }}</text>
						<text class="timeline-time">{{ item.time }}</text>
					</view>
				</view>
			</view>
		</view>
		
		<view class="order-actions" v-if="showActions">
			<view 
				v-if="order.orderStatus === 1" 
				class="order-action-btn order-action-btn--cancel"
				@click="cancelOrder"
			>
				<text class="order-action-btn-text">å–æ¶ˆè®¢å•</text>
			</view>
			<view 
				v-if="order.orderStatus === 3 && order.orderType === 1" 
				class="order-action-btn order-action-btn--redeem"
				@click="redeemOrder"
			>
				<text class="order-action-btn-text">ç”³è¯·èµå›</text>
			</view>
			<view 
				v-if="order.orderStatus === 5" 
				class="order-action-btn order-action-btn--retry"
				@click="retryOrder"
			>
				<text class="order-action-btn-text">é‡æ–°æäº¤</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getOrderDetail, getProductDetail } from '@/api/trade.uts'
	import { formatDateTime } from '@/utils/date.uts'
	import { ORDER_STATUS_MAP, ORDER_TYPE_MAP } from '@/config/index.uts'
	import type { Order, Product } from '@/api/trade.uts'
	
	interface TimelineItem {
		text: string
		time: string
	}
	
	export default {
		data() {
			return {
				orderId: 0,
				order: {} as Order,
				productInfo: {} as Product,
				timeline: [] as TimelineItem[]
			}
		},
		computed: {
			showActions(): boolean {
				return this.order.orderStatus === 1 || 
					this.order.orderStatus === 3 || 
					this.order.orderStatus === 5
			}
		},
		onLoad(options: any) {
			if (options.id) {
				this.orderId = Number(options.id)
				this.loadOrderDetail()
			}
		},
		methods: {
			async loadOrderDetail() {
				try {
					const res = await getOrderDetail(this.orderId)
					this.order = res.data
					this.loadProductInfo()
					this.buildTimeline()
				} catch (e) {
					console.error('è·å–è®¢å•è¯¦æƒ…å¤±è´¥:', e)
					// æ¨¡æ‹Ÿæ•°æ®
					this.order = {
						orderId: this.orderId,
						orderNo: 'ORD' + Date.now(),
						userId: 1,
						productId: 1,
						orderType: 1,
						orderStatus: 2,
						quantity: 10000,
						price: 1,
						amount: 10000,
						fee: 0,
						createdAt: new Date(Date.now() - 3600000).toISOString(),
						updatedAt: new Date().toISOString()
					}
					this.buildTimeline()
				}
			},
			
			async loadProductInfo() {
				try {
					const res = await getProductDetail(this.order.productId)
					this.productInfo = res.data
				} catch (e) {
					console.error('è·å–äº§å“ä¿¡æ¯å¤±è´¥:', e)
				}
			},
			
			buildTimeline() {
				const timeline: TimelineItem[] = []
				
				if (this.order.orderStatus >= 1) {
					timeline.push({
						text: 'è®¢å•å·²æäº?,
						time: this.formatTime(this.order.createdAt)
					})
				}
				if (this.order.orderStatus >= 2) {
					timeline.push({
						text: 'è®¢å•å¤„ç†ä¸?,
						time: this.formatTime(this.order.updatedAt)
					})
				}
				if (this.order.orderStatus === 3) {
					timeline.push({
						text: 'äº¤æ˜“å·²æˆäº?,
						time: this.formatTime(this.order.updatedAt)
					})
				}
				if (this.order.orderStatus === 4) {
					timeline.push({
						text: 'è®¢å•å·²å–æ¶?,
						time: this.formatTime(this.order.updatedAt)
					})
				}
				if (this.order.orderStatus === 5) {
					timeline.push({
						text: 'äº¤æ˜“å¤±è´¥',
						time: this.formatTime(this.order.updatedAt)
					})
				}
				
				this.timeline = timeline.reverse()
			},
			
			formatMoney(num: number): string {
				if (!num) return '0.00'
				return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
			},
			
			formatTime(time: string): string {
				if (!time) return ''
				return formatDateTime(time)
			},
			
			getStatusText(status: number): string {
				return ORDER_STATUS_MAP[status] || 'æœªçŸ¥'
			},
			
			getStatusDesc(status: number): string {
				const descMap: Record<number, string> = {
					1: 'è®¢å•æ­£åœ¨ç­‰å¾…å¤„ç†',
					2: 'è®¢å•æ­£åœ¨å¤„ç†ä¸­ï¼Œè¯·è€å¿ƒç­‰å¾…',
					3: 'è®¢å•å·²æˆäº¤ï¼Œæ”¶ç›Šå°†äºT+1æ—¥å¼€å§‹è®¡ç®?,
					4: 'è®¢å•å·²å–æ¶?,
					5: 'è®¢å•å¤„ç†å¤±è´¥ï¼Œè¯·é‡è¯•æˆ–è”ç³»å®¢æœ?
				}
				return descMap[status] || ''
			},
			
			getStatusIcon(status: number): string {
				const iconMap: Record<number, string> = {
					1: 'â?,
					2: 'ğŸ”„',
					3: 'âœ?,
					4: 'â?,
					5: 'âš ï¸'
				}
				return iconMap[status] || 'ğŸ“‹'
			},
			
			getStatusCardClass(status: number): string {
				const classMap: Record<number, string> = {
					1: 'order-status-card--pending',
					2: 'order-status-card--processing',
					3: 'order-status-card--success',
					4: 'order-status-card--cancelled',
					5: 'order-status-card--failed'
				}
				return classMap[status] || ''
			},
			
			getOrderTypeText(type: number): string {
				return ORDER_TYPE_MAP[type] || 'æœªçŸ¥'
			},
			
			copyOrderNo() {
				uni.setClipboardData({
					data: this.order.orderNo,
					success: () => {
						uni.showToast({ title: 'å·²å¤åˆ?, icon: 'success' })
					}
				})
			},
			
			cancelOrder() {
				uni.showModal({
					title: 'ç¡®è®¤å–æ¶ˆ',
					content: 'ç¡®å®šè¦å–æ¶ˆæ­¤è®¢å•å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							uni.showToast({ title: 'å–æ¶ˆè®¢å•åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
						}
					}
				})
			},
			
			redeemOrder() {
				uni.navigateTo({
					url: `/pages/redeem/redeem?orderId=${this.orderId}`
				})
			},
			
			retryOrder() {
				uni.showToast({ title: 'é‡è¯•åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
			}
		}
	}
</script>

<style lang="scss">
	@import './order-detail.scss';
</style>
