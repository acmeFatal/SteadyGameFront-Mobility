<template>
	<view class="orders-page">
		<sg-navbar title="æˆ‘çš„è®¢å•" />
		
		<view class="orders-tabs">
			<view 
				v-for="(tab, index) in tabs" 
				:key="index"
				class="orders-tab"
				:class="{ 'orders-tab--active': currentTab === index }"
				@click="switchTab(index)"
			>
				<text class="orders-tab-text">{{ tab.name }}</text>
			</view>
		</view>
		
		<scroll-view 
			class="orders-list" 
			scroll-y
			@scrolltolower="loadMore"
			refresher-enabled
			:refresher-triggered="isRefreshing"
			@refresherrefresh="onRefresh"
		>
			<view 
				v-for="(order, index) in orderList" 
				:key="index"
				class="order-item"
				@click="goToOrderDetail(order.orderId)"
			>
				<view class="order-header">
					<text class="order-no">è®¢å•å·ï¼š{{ order.orderNo }}</text>
					<text class="order-status" :class="getStatusClass(order.orderStatus)">
						{{ getStatusText(order.orderStatus) }}
					</text>
				</view>
				<view class="order-body">
					<view class="order-info">
						<text class="order-type">{{ getOrderTypeText(order.orderType) }}</text>
						<text class="order-product">äº§å“IDï¼š{{ order.productId }}</text>
					</view>
					<view class="order-amount">
						<text class="order-amount-value">Â¥{{ formatMoney(order.amount) }}</text>
						<text class="order-amount-label">äº¤æ˜“é‡‘é¢</text>
					</view>
				</view>
				<view class="order-footer">
					<text class="order-time">{{ formatTime(order.createdAt) }}</text>
					<view class="order-actions">
						<view 
							v-if="order.orderStatus === 1" 
							class="order-btn order-btn--cancel"
							@click.stop="cancelOrder(order)"
						>
							<text class="order-btn-text">å–æ¶ˆè®¢å•</text>
						</view>
						<view 
							v-if="order.orderStatus === 5" 
							class="order-btn order-btn--retry"
							@click.stop="retryOrder(order)"
						>
							<text class="order-btn-text">é‡è¯•</text>
						</view>
					</view>
				</view>
			</view>
			
			<sg-empty v-if="orderList.length === 0 && !loading" text="æš‚æ— è®¢å•" />
			
			<view v-if="loading" class="orders-loading">
				<text class="orders-loading-text">åŠ è½½ä¸?..</text>
			</view>
		</scroll-view>
	</view>
</template>

<script lang="uts">
	import { getOrdersWithFilter, cancelOrder as apiCancelOrder, retryOrder as apiRetryOrder } from '@/api/trade.uts'
	import { formatDateTime } from '@/utils/date.uts'
	import { ORDER_STATUS_MAP, ORDER_TYPE_MAP } from '@/config/index.uts'
	import type { Order } from '@/api/trade.uts'
	
	interface Tab {
		name: string
		status: number | null
	}
	
	export default {
		data() {
			return {
				currentTab: 0,
				tabs: [
					{ name: 'å…¨éƒ¨', status: null },
					{ name: 'å¾…å¤„ç?, status: 1 },
					{ name: 'å¤„ç†ä¸?, status: 2 },
					{ name: 'å·²æˆäº?, status: 3 },
					{ name: 'å·²å–æ¶?, status: 4 }
				] as Tab[],
				orderList: [] as Order[],
				loading: false,
				isRefreshing: false,
				page: 1,
				hasMore: true
			}
		},
		onLoad() {
			this.loadOrders()
		},
		methods: {
			switchTab(index: number) {
				this.currentTab = index
				this.page = 1
				this.hasMore = true
				this.orderList = []
				this.loadOrders()
			},
			
			async loadOrders() {
				if (this.loading || !this.hasMore) return
				
				this.loading = true
				try {
					const status = this.tabs[this.currentTab].status
					const res = await getOrdersWithFilter({
						status: status || undefined,
						page: this.page,
						size: 10
					})
					
					const newOrders = res.data || []
					if (this.page === 1) {
						this.orderList = newOrders
					} else {
						this.orderList = [...this.orderList, ...newOrders]
					}
					
					this.hasMore = newOrders.length >= 10
					this.page++
				} catch (e) {
					console.error('è·å–è®¢å•å¤±è´¥:', e)
				} finally {
					this.loading = false
					this.isRefreshing = false
				}
			},
			
			loadMore() {
				this.loadOrders()
			},
			
			onRefresh() {
				this.isRefreshing = true
				this.page = 1
				this.hasMore = true
				this.loadOrders()
			},
			
			formatMoney(num: number): string {
				return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
			},
			
			formatTime(time: string): string {
				return formatDateTime(time)
			},
			
			getStatusText(status: number): string {
				return ORDER_STATUS_MAP[status] || 'æœªçŸ¥'
			},
			
			getStatusClass(status: number): string {
				const classMap: Record<number, string> = {
					1: 'order-status--pending',
					2: 'order-status--processing',
					3: 'order-status--success',
					4: 'order-status--cancelled',
					5: 'order-status--failed'
				}
				return classMap[status] || ''
			},
			
			getOrderTypeText(type: number): string {
				return ORDER_TYPE_MAP[type] || 'æœªçŸ¥'
			},
			
			goToOrderDetail(orderId: number) {
				uni.navigateTo({ url: `/pages/order-detail/order-detail?id=${orderId}` })
			},
			
			async cancelOrder(order: Order) {
				uni.showModal({
					title: 'æç¤º',
					content: 'ç¡®å®šè¦å–æ¶ˆè¯¥è®¢å•å—ï¼Ÿ',
					success: async (res) => {
						if (res.confirm) {
							// éœ€è¦è¾“å…¥äº¤æ˜“å¯†ç ?
							// è¿™é‡Œç®€åŒ–å¤„ç?
							uni.showToast({ title: 'å–æ¶ˆè®¢å•åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
						}
					}
				})
			},
			
			async retryOrder(order: Order) {
				uni.showToast({ title: 'é‡è¯•åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
			}
		}
	}
</script>

<style lang="scss">
	@import './orders.scss';
</style>
