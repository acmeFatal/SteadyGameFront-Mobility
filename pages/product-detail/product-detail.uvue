<template>
	<view class="detail-page">
		<sg-navbar title="äº§å“è¯¦æƒ…" />
		
		<scroll-view class="detail-content" scroll-y>
			<view class="detail-header">
				<text class="detail-name">{{ product.productName }}</text>
				<view class="detail-tags">
					<view class="detail-tag" :class="getRiskClass(product.riskLevel)">
						<text class="detail-tag-text">{{ getRiskText(product.riskLevel) }}</text>
					</view>
					<view class="detail-tag detail-tag--type">
						<text class="detail-tag-text">{{ getProductType(product.productType) }}</text>
					</view>
				</view>
			</view>
			
			<view class="detail-rate-card">
				<view class="detail-rate">
					<text class="detail-rate-value">{{ (product.expectedReturn * 100).toFixed(2) }}</text>
					<text class="detail-rate-unit">%</text>
				</view>
				<text class="detail-rate-label">é¢„æœŸå¹´åŒ–æ”¶ç›Šç‡</text>
				<view class="detail-rate-info">
					<view class="detail-rate-item">
						<text class="detail-rate-item-value">Â¥{{ formatMoney(product.minInvestment) }}</text>
						<text class="detail-rate-item-label">èµ·è´­é‡‘é¢</text>
					</view>
					<view class="detail-rate-divider"></view>
					<view class="detail-rate-item">
						<text class="detail-rate-item-value">{{ product.investmentPeriod }}å¤©</text>
						<text class="detail-rate-item-label">æŠ•èµ„æœŸé™</text>
					</view>
					<view class="detail-rate-divider"></view>
					<view class="detail-rate-item">
						<text class="detail-rate-item-value">T+1</text>
						<text class="detail-rate-item-label">åˆ°è´¦æ—¶é—´</text>
					</view>
				</view>
			</view>
			
			<view class="detail-section">
				<text class="detail-section-title">äº§å“ä»‹ç»</text>
				<text class="detail-section-content">{{ product.description || 'æš‚æ— ä»‹ç»' }}</text>
			</view>
			
			<view class="detail-section">
				<text class="detail-section-title">é£é™©æç¤º</text>
				<view class="detail-risk-tips">
					<view class="detail-risk-item">
						<text class="detail-risk-icon">âš ï¸</text>
						<text class="detail-risk-text">ç†è´¢éå­˜æ¬¾ï¼Œäº§å“æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…</text>
					</view>
					<view class="detail-risk-item">
						<text class="detail-risk-icon">ğŸ“Š</text>
						<text class="detail-risk-text">æœ¬äº§å“é£é™©ç­‰çº§ä¸º{{ getRiskText(product.riskLevel) }}ï¼Œé€‚åˆ{{ getRiskSuitText(product.riskLevel) }}æŠ•èµ„è€…</text>
					</view>
					<view class="detail-risk-item">
						<text class="detail-risk-icon">ğŸ“‹</text>
						<text class="detail-risk-text">è´­ä¹°å‰è¯·ä»”ç»†é˜…è¯»äº§å“è¯´æ˜ä¹¦å’Œé£é™©æ­ç¤ºä¹¦</text>
					</view>
				</view>
			</view>
			
			<view class="detail-section">
				<text class="detail-section-title">äº¤æ˜“è§„åˆ™</text>
				<view class="detail-rules">
					<view class="detail-rule-item">
						<text class="detail-rule-label">ç”³è´­æ—¶é—´</text>
						<text class="detail-rule-value">å·¥ä½œæ—¥ 9:00-15:00</text>
					</view>
					<view class="detail-rule-item">
						<text class="detail-rule-label">èµå›æ—¶é—´</text>
						<text class="detail-rule-value">å·¥ä½œæ—¥ 9:00-15:00</text>
					</view>
					<view class="detail-rule-item">
						<text class="detail-rule-label">èµ·è´­é‡‘é¢</text>
						<text class="detail-rule-value">Â¥{{ formatMoney(product.minInvestment) }}èµ·</text>
					</view>
					<view class="detail-rule-item">
						<text class="detail-rule-label">è¿½åŠ é‡‘é¢</text>
						<text class="detail-rule-value">Â¥100èµ·</text>
					</view>
				</view>
			</view>
		</scroll-view>
		
		<view class="detail-footer">
			<view class="detail-footer-left">
				<view class="detail-action" @click="toggleFavorite">
					<text class="detail-action-icon">{{ isFavorite ? 'â¤ï¸' : 'ğŸ¤' }}</text>
					<text class="detail-action-text">{{ isFavorite ? 'å·²æ”¶è—' : 'æ”¶è—' }}</text>
				</view>
				<view class="detail-action" @click="shareProduct">
					<text class="detail-action-icon">ğŸ“¤</text>
					<text class="detail-action-text">åˆ†äº«</text>
				</view>
			</view>
			<view class="detail-buy-btn" @click="buyProduct">
				<text class="detail-buy-btn-text">ç«‹å³è´­ä¹°</text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getProductDetail } from '@/api/trade.uts'
	import { RISK_LEVEL_MAP } from '@/config/index.uts'
	import type { Product } from '@/api/trade.uts'
	
	export default {
		data() {
			return {
				productId: 0,
				product: {} as Product,
				isFavorite: false
			}
		},
		onLoad(options: any) {
			if (options.id) {
				this.productId = Number(options.id)
				this.loadProduct()
			}
		},
		methods: {
			async loadProduct() {
				try {
					const res = await getProductDetail(this.productId)
					this.product = res.data
				} catch (e) {
					console.error('è·å–äº§å“è¯¦æƒ…å¤±è´¥:', e)
				}
			},
			
			formatMoney(num: number): string {
				if (!num) return '0'
				return num.toFixed(0).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
			},
			
			getRiskText(level: number): string {
				return RISK_LEVEL_MAP[level] || 'æœªçŸ¥'
			},
			
			getRiskSuitText(level: number): string {
				const suitMap: Record<number, string> = {
					1: 'ä¿å®ˆå‹åŠä»¥ä¸Š',
					2: 'ç¨³å¥å‹åŠä»¥ä¸Š',
					3: 'å¹³è¡¡å‹åŠä»¥ä¸Š',
					4: 'ç§¯æå‹åŠä»¥ä¸Š',
					5: 'æ¿€è¿›å‹'
				}
				return suitMap[level] || 'æ‰€æœ‰'
			},
			
			getRiskClass(level: number): string {
				const classMap: Record<number, string> = {
					1: 'detail-tag--low',
					2: 'detail-tag--low-mid',
					3: 'detail-tag--mid',
					4: 'detail-tag--mid-high',
					5: 'detail-tag--high'
				}
				return classMap[level] || ''
			},
			
			getProductType(type: number): string {
				const typeMap: Record<number, string> = {
					1: 'è´§å¸åŸºé‡‘',
					2: 'å€ºåˆ¸åŸºé‡‘',
					3: 'æ··åˆåŸºé‡‘',
					4: 'è‚¡ç¥¨åŸºé‡‘',
					5: 'ç†è´¢äº§å“'
				}
				return typeMap[type] || 'å…¶ä»–'
			},
			
			toggleFavorite() {
				this.isFavorite = !this.isFavorite
				uni.showToast({
					title: this.isFavorite ? 'å·²æ·»åŠ æ”¶è—' : 'å·²å–æ¶ˆæ”¶è—',
					icon: 'success'
				})
			},
			
			shareProduct() {
				uni.share({
					provider: 'weixin',
					type: 0,
					title: this.product.productName,
					summary: `é¢„æœŸå¹´åŒ–æ”¶ç›Š${(this.product.expectedReturn * 100).toFixed(2)}%`,
					success: () => {
						uni.showToast({ title: 'åˆ†äº«æˆåŠŸ', icon: 'success' })
					},
					fail: () => {
						uni.showToast({ title: 'åˆ†äº«åŠŸèƒ½å¼€å‘ä¸­', icon: 'none' })
					}
				})
			},
			
			buyProduct() {
				uni.navigateTo({
					url: `/pages/buy/buy?productId=${this.productId}`
				})
			}
		}
	}
</script>
