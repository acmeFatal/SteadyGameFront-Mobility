<template>
	<view class="profile-page">
		<sg-navbar title="ä¸ªäººèµ„æ–™" />
		
		<view class="profile-avatar-section" @click="changeAvatar">
			<text class="profile-label">å¤´åƒ</text>
			<view class="profile-avatar-wrap">
				<image class="profile-avatar" :src="userInfo.avatar || '/static/default-avatar.png'" mode="aspectFill"></image>
				<text class="profile-arrow">â€?/text>
			</view>
		</view>
		
		<view class="profile-form">
			<view class="profile-item" @click="editField('realName')">
				<text class="profile-item-label">çœŸå®å§“å</text>
				<text class="profile-item-value">{{ userInfo.realName || 'æœªè®¾ç½? }}</text>
				<text class="profile-arrow">â€?/text>
			</view>
			
			<view class="profile-item">
				<text class="profile-item-label">ç”¨æˆ·å?/text>
				<text class="profile-item-value">{{ userInfo.username }}</text>
			</view>
			
			<view class="profile-item" @click="editField('gender')">
				<text class="profile-item-label">æ€§åˆ«</text>
				<text class="profile-item-value">{{ getGenderText(userInfo.gender) }}</text>
				<text class="profile-arrow">â€?/text>
			</view>
			
			<view class="profile-item" @click="editField('birthDate')">
				<text class="profile-item-label">å‡ºç”Ÿæ—¥æœŸ</text>
				<text class="profile-item-value">{{ userInfo.birthDate || 'æœªè®¾ç½? }}</text>
				<text class="profile-arrow">â€?/text>
			</view>
		</view>
		
		<view class="profile-form">
			<view class="profile-item">
				<text class="profile-item-label">æ‰‹æœºå?/text>
				<text class="profile-item-value">{{ formatPhone(userInfo.phone) }}</text>
				<view v-if="userInfo.phoneVerified" class="profile-verified">
					<text class="profile-verified-text">å·²éªŒè¯?/text>
				</view>
			</view>
			
			<view class="profile-item">
				<text class="profile-item-label">é‚®ç®±</text>
				<text class="profile-item-value">{{ formatEmail(userInfo.email) }}</text>
				<view v-if="userInfo.emailVerified" class="profile-verified">
					<text class="profile-verified-text">å·²éªŒè¯?/text>
				</view>
			</view>
		</view>
		
		<view class="profile-form">
			<view class="profile-item" @click="goToUserProfile">
				<text class="profile-item-label">ç”¨æˆ·ç”»åƒ</text>
				<text class="profile-item-value">æŸ¥çœ‹/ç¼–è¾‘</text>
				<text class="profile-arrow">â€?/text>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getUserInfo, updateUserInfo } from '@/api/user.uts'
	import { formatPhone, formatEmail } from '@/utils/format.uts'
	import { setStorage } from '@/utils/storage.uts'
	import { USER_INFO_KEY } from '@/config/index.uts'
	import type { UserInfo, UpdateUserInfoParams } from '@/api/user.uts'
	
	export default {
		data() {
			return {
				userInfo: {} as UserInfo,
				showGenderPicker: false,
				showDatePicker: false,
				genderOptions: ['æœªçŸ¥', 'ç”?, 'å¥?]
			}
		},
		onLoad() {
			this.loadUserInfo()
		},
		methods: {
			async loadUserInfo() {
				try {
					const res = await getUserInfo()
					this.userInfo = res.data
				} catch (e) {
					console.error('è·å–ç”¨æˆ·ä¿¡æ¯å¤±è´¥:', e)
				}
			},
			
			formatPhone(phone: string): string {
				return formatPhone(phone)
			},
			
			formatEmail(email: string): string {
				return formatEmail(email)
			},
			
			getGenderText(gender: number): string {
				const genderMap: Record<number, string> = {
					0: 'æœªçŸ¥',
					1: 'ç”?,
					2: 'å¥?
				}
				return genderMap[gender] || 'æœªçŸ¥'
			},
			
			changeAvatar() {
				uni.chooseImage({
					count: 1,
					sizeType: ['compressed'],
					sourceType: ['album', 'camera'],
					success: (res) => {
						const tempFilePath = res.tempFilePaths[0]
						this.uploadAvatar(tempFilePath)
					}
				})
			},
			
			async uploadAvatar(filePath: string) {
				uni.showLoading({ title: 'ä¸Šä¼ ä¸?..' })
				try {
					// å®é™…åº”ä¸Šä¼ åˆ°æœåŠ¡å™¨ï¼Œè¿™é‡Œç®€åŒ–å¤„ç?
					this.userInfo.avatar = filePath
					uni.showToast({ title: 'å¤´åƒå·²æ›´æ–?, icon: 'success' })
				} catch (e) {
					console.error('ä¸Šä¼ å¤´åƒå¤±è´¥:', e)
				} finally {
					uni.hideLoading()
				}
			},
			
			editField(field: string) {
				if (field === 'realName') {
					uni.showModal({
						title: 'ä¿®æ”¹çœŸå®å§“å',
						editable: true,
						placeholderText: 'è¯·è¾“å…¥çœŸå®å§“å?,
						success: async (res) => {
							if (res.confirm && res.content) {
								await this.updateField({ realName: res.content })
							}
						}
					})
				} else if (field === 'gender') {
					uni.showActionSheet({
						itemList: ['ç”?, 'å¥?],
						success: async (res) => {
							const gender = res.tapIndex + 1
							await this.updateField({ gender })
						}
					})
				} else if (field === 'birthDate') {
					// ä½¿ç”¨æ—¥æœŸé€‰æ‹©å™?
					uni.showToast({ title: 'è¯·ä½¿ç”¨æ—¥æœŸé€‰æ‹©å™?, icon: 'none' })
				}
			},
			
			async updateField(params: UpdateUserInfoParams) {
				try {
					const res = await updateUserInfo(params)
					this.userInfo = res.data
					setStorage(USER_INFO_KEY, this.userInfo)
					uni.showToast({ title: 'æ›´æ–°æˆåŠŸ', icon: 'success' })
				} catch (e) {
					console.error('æ›´æ–°å¤±è´¥:', e)
				}
			},
			
			onGenderChange(e: any) {
				const index = e.detail.value
				this.updateField({ gender: index })
			},
			
			onDateChange(e: any) {
				const date = e.detail.value
				this.updateField({ birthDate: date })
			},
			
			goToUserProfile() {
				uni.navigateTo({ url: '/pages/user-profile/user-profile' })
			}
		}
	}
</script>

<style lang="scss">
	@import './profile.scss';
</style>
