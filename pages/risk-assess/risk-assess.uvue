<template>
	<view class="risk-page">
		<sg-navbar title="é£é™©è¯„ä¼°" />
		
		<view v-if="!showResult" class="risk-questions">
			<view class="risk-progress">
				<view class="risk-progress-bar">
					<view class="risk-progress-fill" :style="{ width: progressWidth }"></view>
				</view>
				<text class="risk-progress-text">{{ currentIndex + 1 }}/{{ questions.length }}</text>
			</view>
			
			<view class="risk-question">
				<text class="risk-question-title">{{ currentQuestion.title }}</text>
				<view class="risk-options">
					<view 
						v-for="(option, index) in currentQuestion.options" 
						:key="index"
						class="risk-option"
						:class="{ 'risk-option--selected': answers[currentIndex] === option.value }"
						@click="selectOption(option.value)"
					>
						<view class="risk-option-radio">
							<view v-if="answers[currentIndex] === option.value" class="risk-option-radio-inner"></view>
						</view>
						<text class="risk-option-text">{{ option.label }}</text>
					</view>
				</view>
			</view>
			
			<view class="risk-actions">
				<view 
					v-if="currentIndex > 0"
					class="risk-btn risk-btn--prev" 
					@click="prevQuestion"
				>
					<text class="risk-btn-text">ä¸Šä¸€é¢?/text>
				</view>
				<view 
					class="risk-btn risk-btn--next" 
					:class="{ 'risk-btn--disabled': !hasAnswer }"
					@click="nextQuestion"
				>
					<text class="risk-btn-text">{{ isLastQuestion ? 'æäº¤' : 'ä¸‹ä¸€é¢? }}</text>
				</view>
			</view>
		</view>
		
		<view v-else class="risk-result">
			<view class="risk-result-card">
				<view class="risk-result-icon">
					<text class="risk-result-icon-text">{{ riskIcon }}</text>
				</view>
				<text class="risk-result-level">{{ riskLevelText }}</text>
				<text class="risk-result-score">è¯„åˆ†ï¼š{{ score }}åˆ?/text>
				<text class="risk-result-desc">{{ riskDesc }}</text>
			</view>
			
			<view class="risk-result-detail">
				<text class="risk-result-detail-title">è¯„ä¼°ç»“æœè¯´æ˜</text>
				<text class="risk-result-detail-text">{{ resultDetail }}</text>
			</view>
			
			<view class="risk-result-actions">
				<view class="risk-btn risk-btn--retest" @click="retest">
					<text class="risk-btn-text">é‡æ–°æµ‹è¯„</text>
				</view>
				<view class="risk-btn risk-btn--confirm" @click="confirmResult">
					<text class="risk-btn-text">ç¡®è®¤ç»“æœ</text>
				</view>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { submitRiskAssessment } from '@/api/user.uts'
	import { RISK_LEVEL_MAP } from '@/config/index.uts'
	
	interface QuestionOption {
		label: string
		value: number
	}
	
	interface Question {
		title: string
		options: QuestionOption[]
	}
	
	export default {
		data() {
			return {
				currentIndex: 0,
				answers: [] as number[],
				showResult: false,
				score: 0,
				riskLevel: 0,
				questions: [
					{
						title: 'æ‚¨çš„å¹´é¾„æ®µæ˜¯ï¼?,
						options: [
							{ label: '25å²ä»¥ä¸?, value: 5 },
							{ label: '25-35å²?, value: 4 },
							{ label: '35-45å²?, value: 3 },
							{ label: '45-55å²?, value: 2 },
							{ label: '55å²ä»¥ä¸?, value: 1 }
						]
					},
					{
						title: 'æ‚¨çš„å®¶åº­å¹´æ”¶å…¥æ°´å¹³æ˜¯ï¼?,
						options: [
							{ label: '10ä¸‡ä»¥ä¸?, value: 1 },
							{ label: '10-30ä¸?, value: 2 },
							{ label: '30-50ä¸?, value: 3 },
							{ label: '50-100ä¸?, value: 4 },
							{ label: '100ä¸‡ä»¥ä¸?, value: 5 }
						]
					},
					{
						title: 'æ‚¨çš„æŠ•èµ„ç»éªŒæœ‰å¤šå°‘å¹´ï¼?,
						options: [
							{ label: 'æ²¡æœ‰æŠ•èµ„ç»éªŒ', value: 1 },
							{ label: '1-3å¹?, value: 2 },
							{ label: '3-5å¹?, value: 3 },
							{ label: '5-10å¹?, value: 4 },
							{ label: '10å¹´ä»¥ä¸?, value: 5 }
						]
					},
					{
						title: 'æ‚¨èƒ½æ‰¿å—çš„æœ€å¤§æŠ•èµ„äºæŸæ¯”ä¾‹æ˜¯ï¼?,
						options: [
							{ label: 'ä¸èƒ½æ¥å—äºæŸ', value: 1 },
							{ label: '10%ä»¥å†…', value: 2 },
							{ label: '10%-30%', value: 3 },
							{ label: '30%-50%', value: 4 },
							{ label: '50%ä»¥ä¸Š', value: 5 }
						]
					},
					{
						title: 'å¦‚æœæ‚¨çš„æŠ•èµ„çŸ­æœŸå†…ä¸‹è·?0%ï¼Œæ‚¨ä¼šï¼Ÿ',
						options: [
							{ label: 'éå¸¸æ‹…å¿ƒï¼Œå…¨éƒ¨å–å‡?, value: 1 },
							{ label: 'æœ‰äº›æ‹…å¿ƒï¼Œå–å‡ºä¸€éƒ¨åˆ†', value: 2 },
							{ label: 'ç»§ç»­è§‚æœ›ï¼Œä¸åšæ“ä½?, value: 3 },
							{ label: 'å¯ä»¥æ¥å—ï¼Œè€ƒè™‘åŠ ä»“', value: 4 },
							{ label: 'è¿™æ˜¯æœºä¼šï¼Œå¤§å¹…åŠ ä»?, value: 5 }
						]
					},
					{
						title: 'æ‚¨çš„ä¸»è¦æŠ•èµ„ç›®æ ‡æ˜¯ï¼Ÿ',
						options: [
							{ label: 'èµ„äº§ä¿å€¼ï¼Œé¿å…äºæŸ', value: 1 },
							{ label: 'ç¨³å¥å¢å€¼ï¼Œç•¥é«˜äºé€šèƒ€', value: 2 },
							{ label: 'å¹³è¡¡æ”¶ç›Šä¸é£é™?, value: 3 },
							{ label: 'è¿½æ±‚è¾ƒé«˜æ”¶ç›Šï¼Œå¯æ‰¿å—æ³¢åŠ¨', value: 4 },
							{ label: 'è¿½æ±‚æœ€é«˜æ”¶ç›Šï¼Œæ¥å—é«˜é£é™?, value: 5 }
						]
					},
					{
						title: 'è¿™ç¬”æŠ•èµ„èµ„é‡‘çš„é¢„è®¡ä½¿ç”¨æ—¶é—´ï¼Ÿ',
						options: [
							{ label: '1å¹´ä»¥å†?, value: 1 },
							{ label: '1-3å¹?, value: 2 },
							{ label: '3-5å¹?, value: 3 },
							{ label: '5-10å¹?, value: 4 },
							{ label: '10å¹´ä»¥ä¸?, value: 5 }
						]
					},
					{
						title: 'æ‚¨ç›®å‰çš„è´Ÿå€ºæƒ…å†µæ˜¯ï¼?,
						options: [
							{ label: 'è´Ÿå€ºè¾ƒé‡ï¼Œè¿˜æ¬¾å‹åŠ›å¤?, value: 1 },
							{ label: 'æœ‰ä¸€å®šè´Ÿå€ºï¼Œå¯æ­£å¸¸å¿è¿?, value: 2 },
							{ label: 'å°‘é‡è´Ÿå€ºï¼Œå‹åŠ›ä¸å¤§', value: 3 },
							{ label: 'åŸºæœ¬æ— è´Ÿå€?, value: 4 },
							{ label: 'æ— ä»»ä½•è´Ÿå€?, value: 5 }
						]
					}
				] as Question[]
			}
		},
		computed: {
			currentQuestion(): Question {
				return this.questions[this.currentIndex]
			},
			progressWidth(): string {
				return ((this.currentIndex + 1) / this.questions.length * 100) + '%'
			},
			hasAnswer(): boolean {
				return this.answers[this.currentIndex] !== undefined
			},
			isLastQuestion(): boolean {
				return this.currentIndex === this.questions.length - 1
			},
			riskLevelText(): string {
				return RISK_LEVEL_MAP[this.riskLevel] || 'æœªçŸ¥'
			},
			riskIcon(): string {
				const icons = ['ğŸ›¡ï¸?, 'ğŸ¦', 'âš–ï¸', 'ğŸ“ˆ', 'ğŸš€']
				return icons[this.riskLevel - 1] || 'â?
			},
			riskDesc(): string {
				const descs = [
					'æ‚¨å±äºä¿å®ˆå‹æŠ•èµ„è€…ï¼Œå»ºè®®ä»¥ä¿æœ¬å‹äº§å“ä¸ºä¸»',
					'æ‚¨å±äºç¨³å¥å‹æŠ•èµ„è€…ï¼Œå»ºè®®ä»¥ä¸­ä½é£é™©äº§å“ä¸ºä¸?,
					'æ‚¨å±äºå¹³è¡¡å‹æŠ•èµ„è€…ï¼Œå¯é€‚å½“é…ç½®ä¸­ç­‰é£é™©äº§å“',
					'æ‚¨å±äºç§¯æå‹æŠ•èµ„è€…ï¼Œå¯é…ç½®è¾ƒé«˜é£é™©äº§å“?,
					'æ‚¨å±äºæ¿€è¿›å‹æŠ•èµ„è€…ï¼Œå¯æ‰¿å—é«˜é£é™©é«˜æ”¶ç›Šäº§å“?
				]
				return descs[this.riskLevel - 1] || ''
			},
			resultDetail(): string {
				return `æ ¹æ®æ‚¨çš„é£é™©æµ‹è¯„ç»“æœï¼Œæ‚¨çš„é£é™©æ‰¿å—èƒ½åŠ›è¯„åˆ†ä¸º${this.score}åˆ†ï¼Œå±äº${this.riskLevelText}æŠ•èµ„è€…ã€‚ç³»ç»Ÿå°†ä¸ºæ‚¨æ¨èä¸æ‚¨é£é™©ç­‰çº§åŒ¹é…çš„ç†è´¢äº§å“ï¼Œä»¥ç¡®ä¿æ‚¨çš„æŠ•èµ„å®‰å…¨å’Œæ”¶ç›Šé¢„æœŸç›¸åŒ¹é…ã€‚`
			}
		},
		methods: {
			selectOption(value: number) {
				this.answers[this.currentIndex] = value
			},
			
			prevQuestion() {
				if (this.currentIndex > 0) {
					this.currentIndex--
				}
			},
			
			nextQuestion() {
				if (!this.hasAnswer) return
				
				if (this.isLastQuestion) {
					this.calculateResult()
				} else {
					this.currentIndex++
				}
			},
			
			calculateResult() {
				let total = 0
				for (const answer of this.answers) {
					total += answer
				}
				this.score = total
				
				if (total <= 12) {
					this.riskLevel = 1
				} else if (total <= 18) {
					this.riskLevel = 2
				} else if (total <= 26) {
					this.riskLevel = 3
				} else if (total <= 34) {
					this.riskLevel = 4
				} else {
					this.riskLevel = 5
				}
				
				this.showResult = true
			},
			
			retest() {
				this.currentIndex = 0
				this.answers = []
				this.showResult = false
				this.score = 0
				this.riskLevel = 0
			},
			
			async confirmResult() {
				try {
					await submitRiskAssessment({
						score: this.score,
						riskLevel: this.riskLevel
					})
					uni.showToast({ title: 'è¯„ä¼°ç»“æœå·²ä¿å­?, icon: 'success' })
					setTimeout(() => {
						uni.navigateBack()
					}, 1500)
				} catch (e) {
					console.error('ä¿å­˜é£é™©è¯„ä¼°å¤±è´¥:', e)
				}
			}
		}
	}
</script>

<style lang="scss">
	@import './risk-assess.scss';
</style>
