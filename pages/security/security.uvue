<template>
	<view class="security-page">
		<sg-navbar title="è´¦å·å®‰å…¨" />
		
		<view class="security-list">
			<view class="security-group">
				<sg-list-item 
					title="ä¿®æ”¹ç™»å½•å¯†ç " 
					icon="ğŸ”"
					@click="goToChangePassword"
				/>
				<sg-list-item 
					title="äº¤æ˜“å¯†ç ç®¡ç†" 
					icon="ğŸ’³"
					:value="hasTradePassword ? 'å·²è®¾ç½? : 'æœªè®¾ç½?"
					@click="goToTradePassword"
				/>
			</view>
			
			<view class="security-group">
				<sg-list-item 
					title="ç»‘å®šæ‰‹æœºå? 
					icon="ğŸ“±"
					:value="phoneDisplay"
					@click="goToBindPhone"
				/>
				<sg-list-item 
					title="ç»‘å®šé‚®ç®±" 
					icon="ğŸ“§"
					:value="emailDisplay"
					@click="goToBindEmail"
				/>
			</view>
			
			<view class="security-group">
				<sg-list-item 
					title="æŒ‡çº¹/é¢å®¹ç™»å½•" 
					icon="ğŸ‘†"
					@click="toggleBiometric"
				>
					<template #right>
						<switch 
							:checked="biometricEnabled" 
							color="#1890FF"
							@change="onBiometricChange"
						/>
					</template>
				</sg-list-item>
			</view>
			
			<view class="security-group">
				<sg-list-item 
					title="ç™»å½•è®¾å¤‡ç®¡ç†" 
					icon="ğŸ“±"
					@click="goToDeviceManage"
				/>
				<sg-list-item 
					title="ç™»å½•æ—¥å¿—" 
					icon="ğŸ“‹"
					@click="goToLoginLogs"
				/>
			</view>
			
			<view class="security-group">
				<sg-list-item 
					title="å†»ç»“è´¦å·" 
					icon="ğŸ”’"
					:border="false"
					@click="freezeAccount"
				/>
			</view>
		</view>
	</view>
</template>

<script lang="uts">
	import { getStorage, setStorage } from '@/utils/storage.uts'
	import { freezeAccount as apiFreezeAccount } from '@/api/user.uts'
	import { supportBiometric } from '@/utils/platform.uts'
	import { USER_INFO_KEY } from '@/config/index.uts'
	import { formatPhone, formatEmail } from '@/utils/format.uts'
	
	interface UserInfo {
		phone?: string
		phoneVerified?: boolean
		email?: string
		emailVerified?: boolean
	}
	
	export default {
		data() {
			return {
				userInfo: {} as UserInfo,
				hasTradePassword: false,
				biometricEnabled: false,
				supportBiometric: false
			}
		},
		computed: {
			phoneDisplay(): string {
				if (!this.userInfo.phone) return 'æœªç»‘å®?
				return formatPhone(this.userInfo.phone) + (this.userInfo.phoneVerified ? ' å·²éªŒè¯? : ' æœªéªŒè¯?)
			},
			emailDisplay(): string {
				if (!this.userInfo.email) return 'æœªç»‘å®?
				return formatEmail(this.userInfo.email) + (this.userInfo.emailVerified ? ' å·²éªŒè¯? : ' æœªéªŒè¯?)
			}
		},
		onLoad() {
			this.loadUserInfo()
			this.checkBiometric()
		},
		methods: {
			loadUserInfo() {
				const userInfo = getStorage<UserInfo>(USER_INFO_KEY)
				if (userInfo) {
					this.userInfo = userInfo
				}
			},
			
			async checkBiometric() {
				this.supportBiometric = await supportBiometric()
				this.biometricEnabled = getStorage<boolean>('biometric_enabled') || false
			},
			
			goToChangePassword() {
				uni.navigateTo({ url: '/pages/change-password/change-password' })
			},
			
			goToTradePassword() {
				uni.navigateTo({ url: '/pages/trade-password/trade-password' })
			},
			
			goToBindPhone() {
				uni.navigateTo({ url: '/pages/bind-phone/bind-phone' })
			},
			
			goToBindEmail() {
				uni.navigateTo({ url: '/pages/bind-email/bind-email' })
			},
			
			toggleBiometric() {
				if (!this.supportBiometric) {
					uni.showToast({ title: 'è®¾å¤‡ä¸æ”¯æŒç”Ÿç‰©è¯†åˆ?, icon: 'none' })
					return
				}
			},
			
			onBiometricChange(e: any) {
				this.biometricEnabled = e.detail.value
				setStorage('biometric_enabled', this.biometricEnabled)
				uni.showToast({ 
					title: this.biometricEnabled ? 'å·²å¼€å? : 'å·²å…³é—?, 
					icon: 'success' 
				})
			},
			
			goToDeviceManage() {
				uni.navigateTo({ url: '/pages/device-manage/device-manage' })
			},
			
			goToLoginLogs() {
				uni.navigateTo({ url: '/pages/login-logs/login-logs' })
			},
			
			freezeAccount() {
				uni.showModal({
					title: 'è­¦å‘Š',
					content: 'å†»ç»“è´¦å·åå°†æ— æ³•ç™»å½•ï¼Œç¡®å®šè¦å†»ç»“å—ï¼Ÿ',
					confirmColor: '#FF4D4F',
					success: async (res) => {
						if (res.confirm) {
							try {
								await apiFreezeAccount()
								uni.showToast({ title: 'è´¦å·å·²å†»ç»?, icon: 'success' })
								setTimeout(() => {
									uni.reLaunch({ url: '/pages/login/login' })
								}, 1500)
							} catch (e) {
								console.error('å†»ç»“è´¦å·å¤±è´¥:', e)
							}
						}
					}
				})
			}
		}
	}
</script>

<style lang="scss">
	@import './security.scss';
</style>
