<template>
	<view class="trade-pwd-page">
		<sg-navbar title="交易密码管理" />
		
		<view v-if="!hasTradePassword" class="trade-pwd-set">
			<view class="trade-pwd-icon">
				<text class="trade-pwd-icon-text">🔐</text>
			</view>
			<text class="trade-pwd-title">设置交易密码</text>
			<text class="trade-pwd-desc">交易密码用于保护您的资金安全，进行交易时需要验证</text>
			
			<view class="trade-pwd-form">
				<view class="trade-pwd-field">
					<text class="trade-pwd-label">交易密码</text>
					<input 
						class="trade-pwd-input"
						v-model="tradePassword"
						placeholder="请输入6位数字密码"
						type="number"
						maxlength="6"
						password
					/>
				</view>
				
				<view class="trade-pwd-field">
					<text class="trade-pwd-label">确认密码</text>
					<input 
						class="trade-pwd-input"
						v-model="confirmPassword"
						placeholder="请再次输入交易密码"
						type="number"
						maxlength="6"
						password
					/>
				</view>
			</view>
			
			<view 
				class="trade-pwd-btn" 
				:class="{ 'trade-pwd-btn--disabled': !canSetPassword }"
				@click="setPassword"
			>
				<text class="trade-pwd-btn-text">设置交易密码</text>
			</view>
		</view>
		
		<view v-else class="trade-pwd-manage">
			<view class="trade-pwd-status">
				<view class="trade-pwd-status-icon">
					<text class="trade-pwd-status-icon-text">✓</text>
				</view>
				<text class="trade-pwd-status-text">交易密码已设置</text>
			</view>
			
			<view class="trade-pwd-menu">
				<sg-list-item 
					title="修改交易密码" 
					icon="🔄"
					@click="showChangeModal = true"
				/>
				<sg-list-item 
					title="重置交易密码" 
					icon="🔑"
					:border="false"
					@click="resetPassword"
				/>
			</view>
		</view>
		
		<sg-modal
			:visible="showChangeModal"
			title="修改交易密码"
			@confirm="confirmChange"
			@cancel="showChangeModal = false"
			@close="showChangeModal = false"
		>
			<view class="change-modal-form">
				<view class="change-modal-field">
					<text class="change-modal-label">原密码</text>
					<input 
						class="change-modal-input"
						v-model="oldTradePassword"
						placeholder="请输入原交易密码"
						type="number"
						maxlength="6"
						password
					/>
				</view>
				<view class="change-modal-field">
					<text class="change-modal-label">新密码</text>
					<input 
						class="change-modal-input"
						v-model="newTradePassword"
						placeholder="请输入新交易密码"
						type="number"
						maxlength="6"
						password
					/>
				</view>
				<view class="change-modal-field">
					<text class="change-modal-label">确认密码</text>
					<input 
						class="change-modal-input"
						v-model="confirmNewPassword"
						placeholder="请确认新交易密码"
						type="number"
						maxlength="6"
						password
					/>
				</view>
			</view>
		</sg-modal>
	</view>
</template>

<script lang="uts">
	import { setTradePassword, changeTradePassword } from '@/api/user.uts'
	import { isValidTradePassword } from '@/utils/validate.uts'
	
	export default {
		data() {
			return {
				hasTradePassword: false,
				tradePassword: '',
				confirmPassword: '',
				showChangeModal: false,
				oldTradePassword: '',
				newTradePassword: '',
				confirmNewPassword: ''
			}
		},
		computed: {
			canSetPassword(): boolean {
				return isValidTradePassword(this.tradePassword) &&
					this.tradePassword === this.confirmPassword
			}
		},
		onLoad() {
			this.checkTradePassword()
		},
		methods: {
			checkTradePassword() {
				// 检查是否已设置交易密码，实际应该调用API
				this.hasTradePassword = false
			},
			
			async setPassword() {
				if (!this.canSetPassword) {
					if (!isValidTradePassword(this.tradePassword)) {
						uni.showToast({ title: '请输入6位数字密码', icon: 'none' })
					} else {
						uni.showToast({ title: '两次密码不一致', icon: 'none' })
					}
					return
				}
				
				try {
					await setTradePassword(this.tradePassword, this.confirmPassword)
					uni.showToast({ title: '设置成功', icon: 'success' })
					this.hasTradePassword = true
					this.tradePassword = ''
					this.confirmPassword = ''
				} catch (e) {
					console.error('设置交易密码失败:', e)
				}
			},
			
			async confirmChange() {
				if (!isValidTradePassword(this.oldTradePassword)) {
					uni.showToast({ title: '请输入原交易密码', icon: 'none' })
					return
				}
				if (!isValidTradePassword(this.newTradePassword)) {
					uni.showToast({ title: '请输入6位新密码', icon: 'none' })
					return
				}
				if (this.newTradePassword !== this.confirmNewPassword) {
					uni.showToast({ title: '两次密码不一致', icon: 'none' })
					return
				}
				
				try {
					await changeTradePassword(
						this.oldTradePassword,
						this.newTradePassword,
						this.confirmNewPassword
					)
					uni.showToast({ title: '修改成功', icon: 'success' })
					this.showChangeModal = false
					this.oldTradePassword = ''
					this.newTradePassword = ''
					this.confirmNewPassword = ''
				} catch (e) {
					console.error('修改交易密码失败:', e)
				}
			},
			
			resetPassword() {
				uni.showModal({
					title: '重置交易密码',
					content: '重置后需要通过手机验证码重新设置，确定继续吗？',
					success: (res) => {
						if (res.confirm) {
							uni.navigateTo({ url: '/pages/reset-trade-password/reset-trade-password' })
						}
					}
				})
			}
		}
	}
</script>
<style lang="scss">
	@import './trade-password.scss';
</style>
