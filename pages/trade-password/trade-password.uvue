<template>
	<view class="trade-pwd-page">
		<sg-navbar title="äº¤æ˜“å¯†ç ç®¡ç†" />
		
		<view v-if="!hasTradePassword" class="trade-pwd-set">
			<view class="trade-pwd-icon">
				<text class="trade-pwd-icon-text">ğŸ”</text>
			</view>
			<text class="trade-pwd-title">è®¾ç½®äº¤æ˜“å¯†ç </text>
			<text class="trade-pwd-desc">äº¤æ˜“å¯†ç ç”¨äºä¿æŠ¤æ‚¨çš„èµ„é‡‘å®‰å…¨ï¼Œè¿›è¡Œäº¤æ˜“æ—¶éœ€è¦éªŒè¯</text>
			
			<view class="trade-pwd-form">
				<view class="trade-pwd-field">
					<text class="trade-pwd-label">äº¤æ˜“å¯†ç </text>
					<input 
						class="trade-pwd-input"
						v-model="tradePassword"
						placeholder="è¯·è¾“å…¥6ä½æ•°å­—å¯†ç "
						type="number"
						maxlength="6"
						password
					/>
				</view>
				
				<view class="trade-pwd-field">
					<text class="trade-pwd-label">ç¡®è®¤å¯†ç </text>
					<input 
						class="trade-pwd-input"
						v-model="confirmPassword"
						placeholder="è¯·å†æ¬¡è¾“å…¥äº¤æ˜“å¯†ç "
						type="number"
						maxlength="6"
						password
					/>
				</view>
			</view>
			
			<view 
				class="trade-pwd-btn" 
				:class="{ 'trade-pwd-btn--disabled': !canSetPassword }"
				@click="setPassword"
			>
				<text class="trade-pwd-btn-text">è®¾ç½®äº¤æ˜“å¯†ç </text>
			</view>
		</view>
		
		<view v-else class="trade-pwd-manage">
			<view class="trade-pwd-status">
				<view class="trade-pwd-status-icon">
					<text class="trade-pwd-status-icon-text">âœ“</text>
				</view>
				<text class="trade-pwd-status-text">äº¤æ˜“å¯†ç å·²è®¾ç½®</text>
			</view>
			
			<view class="trade-pwd-menu">
				<sg-list-item 
					title="ä¿®æ”¹äº¤æ˜“å¯†ç " 
					icon="ğŸ”„"
					@click="showChangeModal = true"
				/>
				<sg-list-item 
					title="é‡ç½®äº¤æ˜“å¯†ç " 
					icon="ğŸ”‘"
					:border="false"
					@click="resetPassword"
				/>
			</view>
		</view>
		
		<sg-modal
			:visible="showChangeModal"
			title="ä¿®æ”¹äº¤æ˜“å¯†ç "
			@confirm="confirmChange"
			@cancel="showChangeModal = false"
			@close="showChangeModal = false"
		>
			<view class="change-modal-form">
				<view class="change-modal-field">
					<text class="change-modal-label">åŸå¯†ç </text>
					<input 
						class="change-modal-input"
						v-model="oldTradePassword"
						placeholder="è¯·è¾“å…¥åŸäº¤æ˜“å¯†ç "
						type="number"
						maxlength="6"
						password
					/>
				</view>
				<view class="change-modal-field">
					<text class="change-modal-label">æ–°å¯†ç </text>
					<input 
						class="change-modal-input"
						v-model="newTradePassword"
						placeholder="è¯·è¾“å…¥æ–°äº¤æ˜“å¯†ç "
						type="number"
						maxlength="6"
						password
					/>
				</view>
				<view class="change-modal-field">
					<text class="change-modal-label">ç¡®è®¤å¯†ç </text>
					<input 
						class="change-modal-input"
						v-model="confirmNewPassword"
						placeholder="è¯·ç¡®è®¤æ–°äº¤æ˜“å¯†ç "
						type="number"
						maxlength="6"
						password
					/>
				</view>
			</view>
		</sg-modal>
	</view>
</template>

<script lang="uts">
	import { setTradePassword, changeTradePassword } from '@/api/user.uts'
	import { isValidTradePassword } from '@/utils/validate.uts'
	
	export default {
		data() {
			return {
				hasTradePassword: false,
				tradePassword: '',
				confirmPassword: '',
				showChangeModal: false,
				oldTradePassword: '',
				newTradePassword: '',
				confirmNewPassword: ''
			}
		},
		computed: {
			canSetPassword(): boolean {
				return isValidTradePassword(this.tradePassword) &&
					this.tradePassword === this.confirmPassword
			}
		},
		onLoad() {
			this.checkTradePassword()
		},
		methods: {
			checkTradePassword() {
				// æ£€æŸ¥æ˜¯å¦å·²è®¾ç½®äº¤æ˜“å¯†ç ï¼Œå®é™…åº”è¯¥è°ƒç”¨API
				this.hasTradePassword = false
			},
			
			async setPassword() {
				if (!this.canSetPassword) {
					if (!isValidTradePassword(this.tradePassword)) {
						uni.showToast({ title: 'è¯·è¾“å…¥6ä½æ•°å­—å¯†ç ', icon: 'none' })
					} else {
						uni.showToast({ title: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', icon: 'none' })
					}
					return
				}
				
				try {
					await setTradePassword(this.tradePassword, this.confirmPassword)
					uni.showToast({ title: 'è®¾ç½®æˆåŠŸ', icon: 'success' })
					this.hasTradePassword = true
					this.tradePassword = ''
					this.confirmPassword = ''
				} catch (e) {
					console.error('è®¾ç½®äº¤æ˜“å¯†ç å¤±è´¥:', e)
				}
			},
			
			async confirmChange() {
				if (!isValidTradePassword(this.oldTradePassword)) {
					uni.showToast({ title: 'è¯·è¾“å…¥åŸäº¤æ˜“å¯†ç ', icon: 'none' })
					return
				}
				if (!isValidTradePassword(this.newTradePassword)) {
					uni.showToast({ title: 'è¯·è¾“å…¥6ä½æ–°å¯†ç ', icon: 'none' })
					return
				}
				if (this.newTradePassword !== this.confirmNewPassword) {
					uni.showToast({ title: 'ä¸¤æ¬¡å¯†ç ä¸ä¸€è‡´', icon: 'none' })
					return
				}
				
				try {
					await changeTradePassword(
						this.oldTradePassword,
						this.newTradePassword,
						this.confirmNewPassword
					)
					uni.showToast({ title: 'ä¿®æ”¹æˆåŠŸ', icon: 'success' })
					this.showChangeModal = false
					this.oldTradePassword = ''
					this.newTradePassword = ''
					this.confirmNewPassword = ''
				} catch (e) {
					console.error('ä¿®æ”¹äº¤æ˜“å¯†ç å¤±è´¥:', e)
				}
			},
			
			resetPassword() {
				uni.showModal({
					title: 'é‡ç½®äº¤æ˜“å¯†ç ',
					content: 'é‡ç½®åéœ€è¦é€šè¿‡æ‰‹æœºéªŒè¯ç é‡æ–°è®¾ç½®ï¼Œç¡®å®šç»§ç»­å—ï¼Ÿ',
					success: (res) => {
						if (res.confirm) {
							uni.navigateTo({ url: '/pages/reset-trade-password/reset-trade-password' })
						}
					}
				})
			}
		}
	}
</script>
