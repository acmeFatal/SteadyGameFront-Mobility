<template>
	<view class="transactions-page">
		<sg-navbar title="äº¤æ˜“æµæ°´" />
		
		<view class="transactions-filter">
			<view class="filter-item" @click="showDatePicker = true">
				<text class="filter-label">{{ dateRange }}</text>
				<text class="filter-arrow">â–?/text>
			</view>
			<view class="filter-item" @click="showTypePicker = true">
				<text class="filter-label">{{ currentTypeText }}</text>
				<text class="filter-arrow">â–?/text>
			</view>
		</view>
		
		<view class="transactions-summary">
			<view class="summary-item">
				<text class="summary-label">æ”¶å…¥</text>
				<text class="summary-value text-rise">+Â¥{{ formatMoney(totalIncome) }}</text>
			</view>
			<view class="summary-item">
				<text class="summary-label">æ”¯å‡º</text>
				<text class="summary-value text-fall">-Â¥{{ formatMoney(totalExpense) }}</text>
			</view>
		</view>
		
		<scroll-view class="transactions-list" scroll-y @scrolltolower="loadMore">
			<view v-for="(group, gIndex) in groupedTransactions" :key="gIndex" class="transaction-group">
				<view class="transaction-date">
					<text class="transaction-date-text">{{ group.date }}</text>
				</view>
				<view 
					v-for="(item, index) in group.items" 
					:key="index"
					class="transaction-item"
				>
					<view class="transaction-icon" :class="getTypeClass(item.transactionType)">
						<text class="transaction-icon-text">{{ getTypeIcon(item.transactionType) }}</text>
					</view>
					<view class="transaction-info">
						<text class="transaction-title">{{ item.description }}</text>
						<text class="transaction-time">{{ formatTime(item.transactionTime) }}</text>
					</view>
					<text 
						class="transaction-amount"
						:class="item.transactionType === 1 ? 'text-rise' : 'text-fall'"
					>{{ item.transactionType === 1 ? '+' : '-' }}Â¥{{ formatMoney(item.amount) }}</text>
				</view>
			</view>
			
			<sg-empty v-if="transactions.length === 0" text="æš‚æ— äº¤æ˜“è®°å½•" />
		</scroll-view>
	</view>
</template>

<script lang="uts">
	import { getAssetTransactions } from '@/api/asset.uts'
	import { formatDate, formatDateTime } from '@/utils/date.uts'
	import type { AssetTransaction } from '@/api/asset.uts'
	
	interface TransactionGroup {
		date: string
		items: AssetTransaction[]
	}
	
	export default {
		data() {
			return {
				dateRange: 'æœ¬æœˆ',
				currentType: 0,
				showDatePicker: false,
				showTypePicker: false,
				transactions: [] as AssetTransaction[],
				page: 1,
				hasMore: true
			}
		},
		computed: {
			currentTypeText(): string {
				const typeMap: Record<number, string> = {
					0: 'å…¨éƒ¨ç±»å‹',
					1: 'æ”¶å…¥',
					2: 'æ”¯å‡º'
				}
				return typeMap[this.currentType] || 'å…¨éƒ¨ç±»å‹'
			},
			totalIncome(): number {
				return this.transactions
					.filter(t => t.transactionType === 1)
					.reduce((sum, t) => sum + t.amount, 0)
			},
			totalExpense(): number {
				return this.transactions
					.filter(t => t.transactionType === 2)
					.reduce((sum, t) => sum + t.amount, 0)
			},
			groupedTransactions(): TransactionGroup[] {
				const groups: Record<string, AssetTransaction[]> = {}
				
				this.transactions.forEach(t => {
					const date = formatDate(t.transactionTime)
					if (!groups[date]) {
						groups[date] = []
					}
					groups[date].push(t)
				})
				
				return Object.keys(groups)
					.sort((a, b) => b.localeCompare(a))
					.map(date => ({
						date,
						items: groups[date]
					}))
			}
		},
		onLoad() {
			this.loadTransactions()
		},
		methods: {
			async loadTransactions() {
				try {
					const res = await getAssetTransactions({
						page: this.page,
						size: 20
					})
					
					const newItems = res.data?.records || []
					if (this.page === 1) {
						this.transactions = newItems
					} else {
						this.transactions = [...this.transactions, ...newItems]
					}
					
					this.hasMore = newItems.length >= 20
				} catch (e) {
					console.error('è·å–äº¤æ˜“æµæ°´å¤±è´¥:', e)
					
					// æ¨¡æ‹Ÿæ•°æ®
					this.transactions = [
						{ id: 1, userId: 1, assetType: 2, transactionType: 1, amount: 5000, transactionTime: new Date().toISOString(), description: 'ç†è´¢æ”¶ç›Šåˆ°è´¦' },
						{ id: 2, userId: 1, assetType: 2, transactionType: 2, amount: 10000, transactionTime: new Date(Date.now() - 86400000).toISOString(), description: 'è´­ä¹°ç†è´¢äº§å“' },
						{ id: 3, userId: 1, assetType: 1, transactionType: 1, amount: 200, transactionTime: new Date(Date.now() - 172800000).toISOString(), description: 'æ´»æœŸåˆ©æ¯' }
					]
				}
			},
			
			loadMore() {
				if (this.hasMore) {
					this.page++
					this.loadTransactions()
				}
			},
			
			formatMoney(num: number): string {
				return num.toFixed(2).replace(/\B(?=(\d{3})+(?!\d))/g, ',')
			},
			
			formatTime(time: string): string {
				const date = new Date(time)
				return `${date.getHours().toString().padStart(2, '0')}:${date.getMinutes().toString().padStart(2, '0')}`
			},
			
			getTypeIcon(type: number): string {
				return type === 1 ? 'ğŸ“¥' : 'ğŸ“¤'
			},
			
			getTypeClass(type: number): string {
				return type === 1 ? 'transaction-icon--income' : 'transaction-icon--expense'
			}
		}
	}
</script>

<style lang="scss">
	@import './transactions.scss';
</style>
