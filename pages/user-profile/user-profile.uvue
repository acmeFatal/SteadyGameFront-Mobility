<template>
	<view class="user-profile-page">
		<sg-navbar title="ç”¨æˆ·ç”»åƒ" />
		
		<view class="profile-header">
			<text class="profile-header-title">å®Œå–„æ‚¨çš„æŠ•èµ„ç”»åƒ</text>
			<text class="profile-header-desc">å¸®åŠ©æˆ‘ä»¬ä¸ºæ‚¨æä¾›æ›´ç²¾å‡†çš„ç†è´¢å»ºè®®</text>
		</view>
		
		<view class="profile-form">
			<view class="profile-section">
				<text class="profile-section-title">åŸºæœ¬ä¿¡æ¯</text>
				
				<view class="profile-field">
					<text class="profile-field-label">èŒä¸š</text>
					<view class="profile-field-input" @click="selectOccupation">
						<text class="profile-field-value" :class="{ 'profile-field-placeholder': !form.occupation }">
							{{ form.occupation || 'è¯·é€‰æ‹©èŒä¸š' }}
						</text>
						<text class="profile-field-arrow">â€?/text>
					</view>
				</view>
				
				<view class="profile-field">
					<text class="profile-field-label">å¹´æ”¶å…?/text>
					<view class="profile-field-input" @click="selectIncome">
						<text class="profile-field-value" :class="{ 'profile-field-placeholder': !form.annualIncomeText }">
							{{ form.annualIncomeText || 'è¯·é€‰æ‹©å¹´æ”¶å…¥èŒƒå›? }}
						</text>
						<text class="profile-field-arrow">â€?/text>
					</view>
				</view>
				
				<view class="profile-field">
					<text class="profile-field-label">å­¦å†</text>
					<view class="profile-field-input" @click="selectEducation">
						<text class="profile-field-value" :class="{ 'profile-field-placeholder': !form.educationLevel }">
							{{ form.educationLevel || 'è¯·é€‰æ‹©å­¦å†' }}
						</text>
						<text class="profile-field-arrow">â€?/text>
					</view>
				</view>
				
				<view class="profile-field">
					<text class="profile-field-label">å®¶åº­çŠ¶å†µ</text>
					<view class="profile-field-input" @click="selectFamily">
						<text class="profile-field-value" :class="{ 'profile-field-placeholder': !form.familyStatusText }">
							{{ form.familyStatusText || 'è¯·é€‰æ‹©å®¶åº­çŠ¶å†µ' }}
						</text>
						<text class="profile-field-arrow">â€?/text>
					</view>
				</view>
			</view>
			
			<view class="profile-section">
				<text class="profile-section-title">æŠ•èµ„ä¿¡æ¯</text>
				
				<view class="profile-field">
					<text class="profile-field-label">æŠ•èµ„ç»éªŒ</text>
					<view class="profile-field-input" @click="selectExperience">
						<text class="profile-field-value" :class="{ 'profile-field-placeholder': !form.investmentExperienceText }">
							{{ form.investmentExperienceText || 'è¯·é€‰æ‹©æŠ•èµ„ç»éªŒ' }}
						</text>
						<text class="profile-field-arrow">â€?/text>
					</view>
				</view>
				
				<view class="profile-field">
					<text class="profile-field-label">é£é™©åå¥½</text>
					<view class="profile-risk-options">
						<view 
							v-for="(item, index) in riskOptions" 
							:key="index"
							class="profile-risk-option"
							:class="{ 'profile-risk-option--active': form.riskPreference === item.value }"
							@click="form.riskPreference = item.value"
						>
							<text class="profile-risk-option-text">{{ item.label }}</text>
						</view>
					</view>
				</view>
				
				<view class="profile-field">
					<text class="profile-field-label">ç†è´¢ç›®æ ‡</text>
					<textarea 
						class="profile-textarea"
						v-model="form.financialGoal"
						placeholder="è¯·æè¿°æ‚¨çš„ç†è´¢ç›®æ ‡ï¼Œå¦‚ï¼šå­å¥³æ•™è‚²ã€å…»è€å‚¨å¤‡ã€èµ„äº§å¢å€¼ç­‰"
						maxlength="200"
					></textarea>
				</view>
			</view>
		</view>
		
		<view class="profile-submit" @click="saveProfile">
			<text class="profile-submit-text">ä¿å­˜ç”»åƒ</text>
		</view>
	</view>
</template>

<script lang="uts">
	import { getUserProfile, saveUserProfile } from '@/api/user.uts'
	import type { UpdateProfileParams } from '@/api/user.uts'
	
	interface RiskOption {
		label: string
		value: number
	}
	
	export default {
		data() {
			return {
				form: {
					occupation: '',
					annualIncome: 0,
					annualIncomeText: '',
					educationLevel: '',
					familyStatus: 0,
					familyStatusText: '',
					investmentExperience: 0,
					investmentExperienceText: '',
					riskPreference: 0,
					financialGoal: ''
				},
				riskOptions: [
					{ label: 'ä¿å®ˆ', value: 1 },
					{ label: 'ç¨³å¥', value: 2 },
					{ label: 'å¹³è¡¡', value: 3 },
					{ label: 'ç§¯æ', value: 4 },
					{ label: 'æ¿€è¿?, value: 5 }
				] as RiskOption[]
			}
		},
		onLoad() {
			this.loadProfile()
		},
		methods: {
			async loadProfile() {
				try {
					const res = await getUserProfile()
					if (res.data) {
						this.form.occupation = res.data.occupation || ''
						this.form.annualIncome = res.data.annualIncome || 0
						this.form.educationLevel = res.data.educationLevel || ''
						this.form.familyStatus = res.data.familyStatus || 0
						this.form.investmentExperience = res.data.investmentExperience || 0
						this.form.riskPreference = res.data.riskPreference || 0
						this.form.financialGoal = res.data.financialGoal || ''
					}
				} catch (e) {
					console.error('è·å–ç”¨æˆ·ç”»åƒå¤±è´¥:', e)
				}
			},
			
			selectOccupation() {
				const items = ['ä¼ä¸šèŒå‘˜', 'å…¬åŠ¡å‘?, 'äº‹ä¸šå•ä½', 'è‡ªç”±èŒä¸š', 'ä¼ä¸šä¸?, 'å­¦ç”Ÿ', 'é€€ä¼?, 'å…¶ä»–']
				uni.showActionSheet({
					itemList: items,
					success: (res) => {
						this.form.occupation = items[res.tapIndex]
					}
				})
			},
			
			selectIncome() {
				const items = ['10ä¸‡ä»¥ä¸?, '10-30ä¸?, '30-50ä¸?, '50-100ä¸?, '100ä¸‡ä»¥ä¸?]
				const values = [50000, 200000, 400000, 750000, 1500000]
				uni.showActionSheet({
					itemList: items,
					success: (res) => {
						this.form.annualIncomeText = items[res.tapIndex]
						this.form.annualIncome = values[res.tapIndex]
					}
				})
			},
			
			selectEducation() {
				const items = ['é«˜ä¸­åŠä»¥ä¸?, 'å¤§ä¸“', 'æœ¬ç§‘', 'ç¡•å£«', 'åšå£«']
				uni.showActionSheet({
					itemList: items,
					success: (res) => {
						this.form.educationLevel = items[res.tapIndex]
					}
				})
			},
			
			selectFamily() {
				const items = ['å•èº«', 'å·²å©šæ— å­å¥?, 'å·²å©šæœ‰å­å¥?, 'å…¶ä»–']
				uni.showActionSheet({
					itemList: items,
					success: (res) => {
						this.form.familyStatusText = items[res.tapIndex]
						this.form.familyStatus = res.tapIndex + 1
					}
				})
			},
			
			selectExperience() {
				const items = ['æ— ç»éª?, '1å¹´ä»¥ä¸?, '1-3å¹?, '3-5å¹?, '5å¹´ä»¥ä¸?]
				uni.showActionSheet({
					itemList: items,
					success: (res) => {
						this.form.investmentExperienceText = items[res.tapIndex]
						this.form.investmentExperience = res.tapIndex
					}
				})
			},
			
			async saveProfile() {
				if (!this.form.riskPreference) {
					uni.showToast({ title: 'è¯·é€‰æ‹©é£é™©åå¥½', icon: 'none' })
					return
				}
				
				try {
					const params: UpdateProfileParams = {
						occupation: this.form.occupation,
						annualIncome: this.form.annualIncome,
						educationLevel: this.form.educationLevel,
						familyStatus: this.form.familyStatus,
						investmentExperience: this.form.investmentExperience,
						riskPreference: this.form.riskPreference,
						financialGoal: this.form.financialGoal
					}
					
					await saveUserProfile(params)
					uni.showToast({ title: 'ä¿å­˜æˆåŠŸ', icon: 'success' })
					
					setTimeout(() => {
						uni.navigateBack()
					}, 1500)
				} catch (e) {
					console.error('ä¿å­˜å¤±è´¥:', e)
				}
			}
		}
	}
</script>

<style lang="scss">
	@import './user-profile.scss';
</style>
